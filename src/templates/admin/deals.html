{% extends "admin/base.html" %}

{% block page_title %}–°–¥–µ–ª–∫–∏{% endblock %}

{% block content %}
<!-- Filters -->
<div class="filters-bar">
    <select id="statusFilter" onchange="loadDeals()">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="cold">–•–æ–ª–æ–¥–Ω–∞—è</option>
        <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
        <option value="warm">–¢—ë–ø–ª–∞—è</option>
        <option value="handed_to_manager">–£ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</option>
        <option value="won">–í—ã–∏–≥—Ä–∞–Ω–∞</option>
        <option value="lost">–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞</option>
    </select>
    <input type="text" id="productFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä—É..." onkeyup="loadDeals()">
</div>

<!-- Help tooltips -->
<div class="help-bar">
    <span class="help-item" title="–•–æ–ª–æ–¥–Ω–∞—è ‚Äî –Ω–∞–π–¥–µ–Ω –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ç—á, –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –Ω–µ –Ω–∞—á–∞—Ç—ã">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∞—è</span>
    <span class="help-item" title="–¢—ë–ø–ª–∞—è ‚Äî AI –ø—Ä–æ–≤—ë–ª –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –ø—Ä–æ–¥–∞–≤–µ—Ü –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω">üî• –¢—ë–ø–ª–∞—è</span>
    <span class="help-item" title="–ú–∞—Ä–∂–∞ ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ –∏ –ø–æ–∫—É–ø–∫–∏">üìä –ú–∞—Ä–∂–∞</span>
    <span class="help-item" title="–ü—Ä–æ—Ñ–∏—Ç ‚Äî –∏—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–¥–µ–ª–∫–∏">üí∞ –ü—Ä–æ—Ñ–∏—Ç</span>
</div>

<!-- Deals Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ü–æ–∫—É–ø–∫–∞</th>
                <th>–ü—Ä–æ–¥–∞–∂–∞</th>
                <th>–ú–∞—Ä–∂–∞</th>
                <th>–ü—Ä–æ—Ñ–∏—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                <th>–î–∞—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="dealsTableBody">
            <tr><td colspan="10" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination"></div>

<script>
let currentPage = 1;

document.addEventListener('DOMContentLoaded', loadDeals);

async function loadDeals() {
    const status = document.getElementById('statusFilter').value;
    const product = document.getElementById('productFilter').value;

    const params = new URLSearchParams({ page: currentPage, per_page: 20 });
    if (status) params.append('status', status);
    if (product) params.append('product', product);

    const response = await fetch(`/api/admin/deals/list?${params}`);
    const data = await response.json();

    renderDeals(data.items);
    renderPagination(data.total, data.page, data.pages);
}

function getStatusLabel(status) {
    const labels = {
        'cold': '–•–æ–ª–æ–¥–Ω–∞—è',
        'in_progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        'warm': '–¢—ë–ø–ª–∞—è',
        'handed_to_manager': '–£ –º–µ–Ω–µ–¥–∂–µ—Ä–∞',
        'won': '–í—ã–∏–≥—Ä–∞–Ω–∞',
        'lost': '–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞'
    };
    return labels[status] || status;
}

function renderDeals(deals) {
    const tbody = document.getElementById('dealsTableBody');

    if (deals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>';
        return;
    }

    tbody.innerHTML = deals.map(deal => `
        <tr onclick="window.location='/admin/deals/${deal.id}'" style="cursor:pointer">
            <td>${deal.id}</td>
            <td>${escapeHtml(deal.product)}</td>
            <td class="text-success">${formatMoney(deal.buy_price)}</td>
            <td class="text-warning">${formatMoney(deal.sell_price)}</td>
            <td>${formatMoney(deal.margin)}</td>
            <td class="text-success">${deal.profit ? formatMoney(deal.profit) : '-'}</td>
            <td><span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span></td>
            <td>${deal.manager_name || '-'}</td>
            <td>${formatDate(deal.created_at)}</td>
            <td class="actions" onclick="event.stopPropagation()">
                <button onclick="window.location='/admin/deals/${deal.id}'" class="btn btn-sm btn-outline">–û—Ç–∫—Ä—ã—Ç—å</button>
            </td>
        </tr>
    `).join('');
}

function renderPagination(total, page, pages) {
    const container = document.getElementById('pagination');
    if (pages <= 1) { container.innerHTML = ''; return; }
    let html = '';
    for (let i = 1; i <= Math.min(pages, 10); i++) {
        html += `<button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}" onclick="goToPage(${i})">${i}</button>`;
    }
    container.innerHTML = html;
}

function goToPage(page) { currentPage = page; loadDeals(); }
function formatDate(dateStr) { return new Date(dateStr).toLocaleDateString('ru-RU'); }
function formatMoney(value) { return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value); }
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
</script>
{% endblock %}
