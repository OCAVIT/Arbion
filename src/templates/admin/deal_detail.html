{% extends "admin/base.html" %}

{% block page_title %}Сделка #{{ deal_id }}{% endblock %}

{% block content %}
<div class="deal-detail-page">
    <!-- Deal Info -->
    <div class="card deal-info-card">
        <div class="card-header">
            <h3>Информация о сделке</h3>
            <span class="badge" id="dealStatus">-</span>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Товар</label>
                    <span id="dealProduct">-</span>
                </div>
                <div class="info-item">
                    <label>Регион</label>
                    <span id="dealRegion">-</span>
                </div>
                <div class="info-item">
                    <label>Цена покупки</label>
                    <span class="text-success" id="dealBuyPrice">-</span>
                </div>
                <div class="info-item">
                    <label>Цена продажи</label>
                    <span class="text-warning" id="dealSellPrice">-</span>
                </div>
                <div class="info-item">
                    <label>Маржа</label>
                    <span id="dealMargin">-</span>
                </div>
                <div class="info-item">
                    <label>Профит</label>
                    <span class="text-success" id="dealProfit">-</span>
                </div>
                <div class="info-item">
                    <label>Менеджер</label>
                    <span id="dealManager">-</span>
                </div>
                <div class="info-item">
                    <label>AI Insight</label>
                    <span id="dealInsight">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Deal Details -->
    <div class="card deal-details-card">
        <div class="card-header">
            <h3>Детали сделки</h3>
            <button onclick="saveDealDetails()" class="btn btn-primary btn-sm">Сохранить</button>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Целевая цена продажи</label>
                    <input type="number" id="targetSellPrice" placeholder="0" step="100">
                </div>
                <div class="info-item">
                    <label>Город продавца</label>
                    <span id="sellerCity">-</span>
                </div>
                <div class="info-item">
                    <label>Состояние</label>
                    <span id="sellerCondition">-</span>
                </div>
                <div class="info-item">
                    <label>Характеристики</label>
                    <span id="sellerSpecs">-</span>
                </div>
                <div class="info-item">
                    <label>Телефон продавца</label>
                    <span id="sellerPhone">-</span>
                </div>
                <div class="info-item">
                    <label>Телефон покупателя</label>
                    <span id="buyerPhone">-</span>
                </div>
            </div>
            <div style="margin-top: 12px;">
                <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">Заметки</label>
                <textarea id="dealNotes" rows="3" placeholder="Заметки к сделке..." style="width:100%;resize:vertical;"></textarea>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card actions-card">
        <div class="card-header">
            <h3>Действия</h3>
        </div>
        <div class="card-body">
            <div class="actions-row">
                <select id="managerSelect">
                    <option value="">Выберите менеджера...</option>
                </select>
                <button onclick="assignManager()" class="btn btn-primary">Назначить</button>
                <button onclick="closeDeal('won')" class="btn btn-success">Закрыть (Выигрыш)</button>
                <button onclick="closeDeal('lost')" class="btn btn-danger">Закрыть (Проигрыш)</button>
                <button onclick="deleteDeal()" class="btn btn-danger" style="margin-left:auto">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Chat Tabs for Mobile -->
    <div class="chat-tabs">
        <button class="chat-tab active" data-chat="seller" onclick="switchChat('seller')">
            Продавец
            <span class="chat-tab-badge" id="sellerBadge">0</span>
        </button>
        <button class="chat-tab" data-chat="buyer" onclick="switchChat('buyer')">
            Покупатель
            <span class="chat-tab-badge" id="buyerBadge">0</span>
        </button>
    </div>

    <!-- Chats Container -->
    <div class="chats-container">
        <!-- Seller Chat -->
        <div class="card chat-card" id="sellerChatCard">
            <div class="card-header chat-card-header">
                <h3>Чат с продавцом</h3>
                <span class="chat-messages-count" id="sellerCount">0 сообщений</span>
            </div>
            <div class="card-body chat-card-body">
                <div class="chat-messages" id="sellerMessages">
                    <div class="loading">Загрузка...</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="sellerMessageInput" placeholder="Написать продавцу...">
                    <button onclick="sendMessage('seller')" class="btn btn-primary">
                        <span class="btn-text">Отправить</span>
                        <span class="btn-icon">&#10148;</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Buyer Chat -->
        <div class="card chat-card" id="buyerChatCard">
            <div class="card-header chat-card-header">
                <h3>Чат с покупателем</h3>
                <span class="chat-messages-count" id="buyerCount">0 сообщений</span>
            </div>
            <div class="card-body chat-card-body">
                <div class="chat-messages" id="buyerMessages">
                    <div class="loading">Загрузка...</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="buyerMessageInput" placeholder="Написать покупателю...">
                    <button onclick="sendMessage('buyer')" class="btn btn-primary">
                        <span class="btn-text">Отправить</span>
                        <span class="btn-icon">&#10148;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Deal Detail Page Styles */
.deal-detail-page {
    max-width: 100%;
}

.deal-info-card .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

/* Chat Tabs (Mobile) */
.chat-tabs {
    display: none;
    margin-bottom: 16px;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    padding: 4px;
    gap: 4px;
}

.chat-tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 14px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.chat-tab.active {
    background: var(--accent);
    color: white;
}

.chat-tab-badge {
    background: var(--bg-hover);
    color: var(--text-secondary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    min-width: 24px;
    text-align: center;
}

.chat-tab.active .chat-tab-badge {
    background: rgba(255,255,255,0.2);
    color: white;
}

/* Chats Container */
.chats-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

/* Chat Card */
.chat-card {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 400px);
    min-height: 400px;
}

.chat-card-header {
    flex-shrink: 0;
}

.chat-card-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    padding: 0 !important;
}

.chat-messages-count {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: normal;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    -webkit-overflow-scrolling: touch;
}

.chat-input {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.chat-input input {
    flex: 1;
    min-width: 0;
}

.chat-input .btn {
    flex-shrink: 0;
    padding: 10px 16px;
}

.chat-input .btn-icon {
    display: none;
}

/* Messages */
.message {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 16px;
    word-break: break-word;
}

.message-ai {
    background: var(--bg-secondary);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-seller {
    background: linear-gradient(135deg, #1e3a5f 0%, #1a365d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-buyer {
    background: linear-gradient(135deg, #3d1e5f 0%, #4a1d6d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-manager {
    background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 11px;
    opacity: 0.8;
}

.message-sender {
    font-weight: 600;
}

.message-content {
    white-space: pre-wrap;
    line-height: 1.4;
}

/* Empty/Loading states */
.empty, .loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

/* Actions Row */
.actions-card .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.actions-card select {
    min-width: 200px;
}

/* Mobile Responsive */
@media (max-width: 1024px) {
    .chats-container {
        grid-template-columns: 1fr;
    }

    .chat-card {
        height: calc(100vh - 350px);
        min-height: 350px;
    }
}

@media (max-width: 768px) {
    .deal-detail-page {
        padding-bottom: 20px;
    }

    .deal-info-card .info-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .info-item {
        padding: 10px;
    }

    .info-item label {
        font-size: 11px;
    }

    .actions-card .actions-row {
        flex-direction: column;
    }

    .actions-card .actions-row select,
    .actions-card .actions-row .btn {
        width: 100%;
    }

    /* Show tabs on mobile */
    .chat-tabs {
        display: flex;
    }

    /* Hide inactive chat on mobile */
    .chats-container {
        display: block;
    }

    .chat-card {
        display: none;
        height: calc(100vh - 320px);
        min-height: 300px;
    }

    .chat-card.active {
        display: flex;
    }

    .chat-card-header h3 {
        font-size: 15px;
    }

    .chat-input {
        padding: 10px 12px;
    }

    .chat-input input {
        font-size: 16px; /* Prevents zoom on iOS */
    }

    .chat-input .btn {
        padding: 10px 12px;
    }

    .chat-input .btn-text {
        display: none;
    }

    .chat-input .btn-icon {
        display: inline;
        font-size: 18px;
    }

    .message {
        max-width: 90%;
        padding: 8px 12px;
    }

    .message-header {
        font-size: 10px;
    }

    .message-content {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .deal-info-card .info-grid {
        grid-template-columns: 1fr;
    }

    .chat-tab {
        padding: 10px 12px;
        font-size: 13px;
    }

    .chat-card {
        height: calc(100vh - 280px);
    }
}
</style>

<script>
const dealId = {{ deal_id }};
let refreshInterval;
let activeChat = 'seller';

document.addEventListener('DOMContentLoaded', () => {
    loadDeal();
    loadMessages();
    loadManagers();

    // Auto-refresh every 5 seconds
    refreshInterval = setInterval(loadMessages, 5000);

    // Mark first chat as active on mobile
    document.getElementById('sellerChatCard').classList.add('active');
});

async function loadDeal() {
    const response = await fetch(`/admin/deals/${dealId}/data`);
    const deal = await response.json();

    document.getElementById('dealStatus').textContent = deal.status;
    document.getElementById('dealStatus').className = `badge badge-${deal.status}`;
    document.getElementById('dealProduct').textContent = deal.product;
    document.getElementById('dealRegion').textContent = deal.region || '-';
    document.getElementById('dealBuyPrice').textContent = formatMoney(deal.buy_price);
    document.getElementById('dealSellPrice').textContent = formatMoney(deal.sell_price);
    document.getElementById('dealMargin').textContent = formatMoney(deal.margin);
    document.getElementById('dealProfit').textContent = deal.profit ? formatMoney(deal.profit) : '-';
    document.getElementById('dealManager').textContent = deal.manager_name || 'Не назначен';
    document.getElementById('dealInsight').textContent = deal.ai_insight || '-';

    // Deal details
    document.getElementById('sellerCity').textContent = deal.seller_city || '-';
    document.getElementById('sellerCondition').textContent = deal.seller_condition || '-';
    document.getElementById('sellerSpecs').textContent = deal.seller_specs || '-';
    document.getElementById('sellerPhone').textContent = deal.seller_phone || '-';
    document.getElementById('buyerPhone').textContent = deal.buyer_phone || '-';
    if (deal.target_sell_price) document.getElementById('targetSellPrice').value = deal.target_sell_price;
    if (deal.notes) document.getElementById('dealNotes').value = deal.notes;
}

async function saveDealDetails() {
    const data = {};
    const targetPrice = document.getElementById('targetSellPrice').value;
    const notes = document.getElementById('dealNotes').value;
    if (targetPrice) data.target_sell_price = parseFloat(targetPrice);
    if (notes !== undefined) data.notes = notes;

    const res = await fetch(`/admin/deals/${dealId}/update`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    if (res.ok) {
        loadDeal();
    } else {
        alert('Ошибка при сохранении');
    }
}

async function loadMessages() {
    const response = await fetch(`/admin/deals/${dealId}/messages`);
    const data = await response.json();

    // Render seller messages
    renderMessages('sellerMessages', data.seller_messages || []);
    document.getElementById('sellerCount').textContent = `${(data.seller_messages || []).length} сообщений`;
    document.getElementById('sellerBadge').textContent = (data.seller_messages || []).length;

    // Render buyer messages
    renderMessages('buyerMessages', data.buyer_messages || []);
    document.getElementById('buyerCount').textContent = `${(data.buyer_messages || []).length} сообщений`;
    document.getElementById('buyerBadge').textContent = (data.buyer_messages || []).length;
}

function renderMessages(containerId, messages) {
    const container = document.getElementById(containerId);

    if (messages.length === 0) {
        container.innerHTML = '<div class="empty">Нет сообщений</div>';
        return;
    }

    const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

    container.innerHTML = messages.map(msg => `
        <div class="message message-${msg.role}">
            <div class="message-header">
                <span class="message-sender">${escapeHtml(msg.sender_name)}</span>
                <span class="message-time">${formatTime(msg.created_at)}</span>
            </div>
            <div class="message-content">${escapeHtml(msg.content)}</div>
        </div>
    `).join('');

    // Auto-scroll to bottom if was at bottom
    if (wasScrolledToBottom) {
        container.scrollTop = container.scrollHeight;
    }
}

async function loadManagers() {
    const response = await fetch('/admin/managers/list?active_only=true');
    const data = await response.json();

    const select = document.getElementById('managerSelect');
    data.items.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.display_name;
        select.appendChild(option);
    });
}

async function assignManager() {
    const managerId = document.getElementById('managerSelect').value;
    if (!managerId) return;

    await fetch(`/admin/deals/${dealId}/assign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manager_id: parseInt(managerId) })
    });
    loadDeal();
}

async function sendMessage(target) {
    const inputId = target === 'seller' ? 'sellerMessageInput' : 'buyerMessageInput';
    const input = document.getElementById(inputId);
    const content = input.value.trim();
    if (!content) return;

    const btn = input.nextElementSibling;
    btn.disabled = true;

    try {
        await fetch(`/admin/deals/${dealId}/message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, target })
        });

        input.value = '';
        loadMessages();
    } finally {
        btn.disabled = false;
    }
}

async function closeDeal(status) {
    const resolution = prompt('Комментарий к закрытию (опционально):');

    await fetch(`/admin/deals/${dealId}/close`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, resolution })
    });
    loadDeal();
}

async function deleteDeal() {
    if (!confirm('Удалить сделку и все связанные переговоры? Это действие необратимо.')) return;

    const res = await fetch(`/admin/deals/${dealId}`, { method: 'DELETE' });
    if (res.ok) {
        window.location.href = '/admin/deals';
    } else {
        alert('Ошибка при удалении сделки');
    }
}

function switchChat(chat) {
    activeChat = chat;

    // Update tabs
    document.querySelectorAll('.chat-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.chat === chat);
    });

    // Update chat cards
    document.getElementById('sellerChatCard').classList.toggle('active', chat === 'seller');
    document.getElementById('buyerChatCard').classList.toggle('active', chat === 'buyer');
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        maximumFractionDigits: 0
    }).format(value);
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();

    if (isToday) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }) +
           ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle Enter key for sending messages
document.getElementById('sellerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('seller');
});

document.getElementById('buyerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('buyer');
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
{% endblock %}
