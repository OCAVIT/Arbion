{% extends "admin/base.html" %}

{% block page_title %}Сделка #{{ deal_id }}{% endblock %}

{% block content %}
<div class="deal-detail-page">
    <!-- Deal Info -->
    <div class="card deal-info-card">
        <div class="card-header">
            <h3>Информация о сделке</h3>
            <span class="badge" id="dealStatus">-</span>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Товар</label>
                    <span id="dealProduct">-</span>
                </div>
                <div class="info-item">
                    <label>Регион</label>
                    <span id="dealRegion">-</span>
                </div>
                <div class="info-item">
                    <label>Цена покупки</label>
                    <span class="text-success" id="dealBuyPrice">-</span>
                </div>
                <div class="info-item">
                    <label>Цена продажи</label>
                    <span class="text-warning" id="dealSellPrice">-</span>
                </div>
                <div class="info-item">
                    <label>Маржа</label>
                    <span id="dealMargin">-</span>
                </div>
                <div class="info-item">
                    <label>Профит</label>
                    <span class="text-success" id="dealProfit">-</span>
                </div>
                <div class="info-item">
                    <label>Менеджер</label>
                    <span id="dealManager">-</span>
                </div>
                <div class="info-item">
                    <label>AI Insight</label>
                    <span id="dealInsight">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Deal Details -->
    <div class="card deal-details-card">
        <div class="card-header">
            <h3>Детали сделки</h3>
            <button onclick="saveDealDetails()" class="btn btn-primary btn-sm">Сохранить</button>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Целевая цена продажи</label>
                    <input type="number" id="targetSellPrice" placeholder="0" step="100">
                </div>
                <div class="info-item">
                    <label>Город продавца</label>
                    <span id="sellerCity">-</span>
                </div>
                <div class="info-item">
                    <label>Состояние</label>
                    <span id="sellerCondition">-</span>
                </div>
                <div class="info-item">
                    <label>Характеристики</label>
                    <span id="sellerSpecs">-</span>
                </div>
                <div class="info-item">
                    <label>Телефон продавца</label>
                    <span id="sellerPhone">-</span>
                </div>
                <div class="info-item">
                    <label>Телефон покупателя</label>
                    <span id="buyerPhone">-</span>
                </div>
            </div>
            <div style="margin-top: 12px;">
                <label style="display:block;margin-bottom:6px;color:var(--text-secondary);font-size:12px;">Заметки</label>
                <textarea id="dealNotes" rows="3" placeholder="Заметки к сделке..." style="width:100%;resize:vertical;"></textarea>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card actions-card">
        <div class="card-header">
            <h3>Действия</h3>
        </div>
        <div class="card-body">
            <div class="actions-row">
                <select id="managerSelect">
                    <option value="">Выберите менеджера...</option>
                </select>
                <button onclick="assignManager()" class="btn btn-primary">Назначить</button>
                <button onclick="closeDeal('won')" class="btn btn-success">Закрыть (Выигрыш)</button>
                <button onclick="closeDeal('lost')" class="btn btn-danger">Закрыть (Проигрыш)</button>
                <button onclick="deleteDeal()" class="btn btn-danger" style="margin-left:auto">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Chat Tabs for Mobile -->
    <div class="chat-tabs">
        <button class="chat-tab active" data-chat="seller" onclick="switchChat('seller')">
            Продавец
            <span class="chat-tab-badge" id="sellerBadge">0</span>
        </button>
        <button class="chat-tab" data-chat="buyer" onclick="switchChat('buyer')">
            Покупатель
            <span class="chat-tab-badge" id="buyerBadge">0</span>
        </button>
    </div>

    <!-- Chats Container -->
    <div class="chats-container">
        <!-- Seller Chat -->
        <div class="card chat-card" id="sellerChatCard">
            <div class="card-header chat-card-header">
                <h3>Чат с продавцом</h3>
                <span class="chat-messages-count" id="sellerCount">0 сообщений</span>
            </div>
            <div class="card-body chat-card-body">
                <div class="chat-messages" id="sellerMessages">
                    <div class="loading">Загрузка...</div>
                </div>
                <div class="reply-preview" id="sellerReplyPreview" style="display:none">
                    <div class="reply-preview-content">
                        <span class="reply-preview-sender" id="sellerReplySender"></span>
                        <span class="reply-preview-text" id="sellerReplyText"></span>
                    </div>
                    <button class="reply-preview-close" onclick="cancelReply('seller')">&times;</button>
                </div>
                <div class="file-preview" id="sellerFilePreview" style="display:none">
                    <span class="file-preview-name" id="sellerFileName"></span>
                    <button class="file-preview-remove" onclick="clearFileSelection('seller')">&times;</button>
                </div>
                <div class="chat-input">
                    <button onclick="document.getElementById('sellerFileInput').click()" class="btn-attach" title="Прикрепить файл">&#128206;</button>
                    <input type="file" id="sellerFileInput" style="display:none" onchange="handleFileSelect('seller', this)" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z">
                    <input type="text" id="sellerMessageInput" placeholder="Написать продавцу...">
                    <button onclick="sendMessage('seller')" class="btn btn-primary">
                        <span class="btn-text">Отправить</span>
                        <span class="btn-icon">&#10148;</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Buyer Chat -->
        <div class="card chat-card" id="buyerChatCard">
            <div class="card-header chat-card-header">
                <h3>Чат с покупателем</h3>
                <span class="chat-messages-count" id="buyerCount">0 сообщений</span>
            </div>
            <div class="card-body chat-card-body">
                <div class="chat-messages" id="buyerMessages">
                    <div class="loading">Загрузка...</div>
                </div>
                <div class="reply-preview" id="buyerReplyPreview" style="display:none">
                    <div class="reply-preview-content">
                        <span class="reply-preview-sender" id="buyerReplySender"></span>
                        <span class="reply-preview-text" id="buyerReplyText"></span>
                    </div>
                    <button class="reply-preview-close" onclick="cancelReply('buyer')">&times;</button>
                </div>
                <div class="file-preview" id="buyerFilePreview" style="display:none">
                    <span class="file-preview-name" id="buyerFileName"></span>
                    <button class="file-preview-remove" onclick="clearFileSelection('buyer')">&times;</button>
                </div>
                <div class="chat-input">
                    <button onclick="document.getElementById('buyerFileInput').click()" class="btn-attach" title="Прикрепить файл">&#128206;</button>
                    <input type="file" id="buyerFileInput" style="display:none" onchange="handleFileSelect('buyer', this)" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z">
                    <input type="text" id="buyerMessageInput" placeholder="Написать покупателю...">
                    <button onclick="sendMessage('buyer')" class="btn btn-primary">
                        <span class="btn-text">Отправить</span>
                        <span class="btn-icon">&#10148;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fullscreen media overlay -->
<div id="mediaOverlay" class="media-overlay" onclick="closeFullscreen()">
    <img id="mediaOverlayImg" src="" alt="Полный размер">
</div>

<style>
/* Deal Detail Page Styles */
.deal-detail-page {
    max-width: 100%;
}

.deal-info-card .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}

/* Chat Tabs (Mobile) */
.chat-tabs {
    display: none;
    margin-bottom: 16px;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    padding: 4px;
    gap: 4px;
}

.chat-tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 14px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.chat-tab.active {
    background: var(--accent);
    color: white;
}

.chat-tab-badge {
    background: var(--bg-hover);
    color: var(--text-secondary);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    min-width: 24px;
    text-align: center;
}

.chat-tab.active .chat-tab-badge {
    background: rgba(255,255,255,0.2);
    color: white;
}

/* Chats Container */
.chats-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

/* Chat Card */
.chat-card {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 400px);
    min-height: 400px;
}

.chat-card-header {
    flex-shrink: 0;
}

.chat-card-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    padding: 0 !important;
}

.chat-messages-count {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: normal;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    -webkit-overflow-scrolling: touch;
}

.chat-input {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.chat-input input[type="text"] {
    flex: 1;
    min-width: 0;
}

.chat-input .btn {
    flex-shrink: 0;
    padding: 10px 16px;
}

.chat-input .btn-icon {
    display: none;
}

/* File attach button */
.btn-attach {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    opacity: 0.6;
    transition: opacity 0.2s;
    flex-shrink: 0;
}

.btn-attach:hover {
    opacity: 1;
}

/* File preview bar */
.file-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--bg-hover, rgba(255,255,255,0.05));
    border-top: 1px solid var(--border-color);
    font-size: 13px;
    gap: 8px;
    flex-shrink: 0;
}

.file-preview-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
}

.file-preview-remove {
    background: none;
    border: none;
    color: var(--danger, #ef4444);
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
    flex-shrink: 0;
}

/* Reply preview bar */
.reply-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: rgba(99, 102, 241, 0.1);
    border-left: 3px solid var(--accent, #6366f1);
    border-top: 1px solid var(--border-color);
    font-size: 13px;
    gap: 8px;
    flex-shrink: 0;
}

.reply-preview-content {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.reply-preview-sender {
    font-weight: 600;
    font-size: 12px;
    display: block;
    color: var(--accent, #6366f1);
}

.reply-preview-text {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-secondary);
    font-size: 12px;
}

.reply-preview-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
    flex-shrink: 0;
}

/* Reply reference in messages - Telegram-like */
.message-reply-ref {
    background: rgba(255, 255, 255, 0.06);
    border-left: 3px solid #34b7f1;
    padding: 5px 10px;
    margin-bottom: 6px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.message-reply-ref:hover {
    background: rgba(255, 255, 255, 0.12);
}

.message-reply-ref.reply-from-seller {
    border-left-color: #4fc3f7;
}

.message-reply-ref.reply-from-buyer {
    border-left-color: #ce93d8;
}

.message-reply-ref.reply-from-manager {
    border-left-color: #6366f1;
}

.message-reply-ref.reply-from-ai {
    border-left-color: #ffa726;
}

.message-reply-ref .reply-ref-sender {
    font-weight: 600;
    font-size: 12px;
    color: #34b7f1;
}

.message-reply-ref.reply-from-seller .reply-ref-sender { color: #4fc3f7; }
.message-reply-ref.reply-from-buyer .reply-ref-sender { color: #ce93d8; }
.message-reply-ref.reply-from-manager .reply-ref-sender { color: #6366f1; }
.message-reply-ref.reply-from-ai .reply-ref-sender { color: #ffa726; }

.message-reply-ref .reply-ref-text {
    opacity: 0.7;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 250px;
}

/* Reply button */
.message-actions {
    display: flex;
    justify-content: flex-start;
    margin-top: 4px;
}

.btn-reply {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.4);
    font-size: 11px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-reply:hover {
    color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.08);
}

.message-manager .message-header {
    opacity: 1;
}

.message-manager .message-reply-ref {
    background: rgba(0, 0, 0, 0.2);
}

.message-manager .message-reply-ref:hover {
    background: rgba(0, 0, 0, 0.3);
}

.message-manager .message-reply-ref .reply-ref-text {
    opacity: 0.9;
}

.message-manager .message-reply-ref.reply-from-manager {
    border-left-color: #c4b5fd;
}

.message-manager .reply-from-manager .reply-ref-sender {
    color: #c4b5fd;
}

.message-manager .btn-reply {
    color: rgba(255, 255, 255, 0.7);
}

.message-manager .btn-reply:hover {
    color: #fff;
    background: rgba(0, 0, 0, 0.15);
}

/* Messages */
.message {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 16px;
    word-break: break-word;
}

.message-ai {
    background: var(--bg-secondary);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-seller {
    background: linear-gradient(135deg, #1e3a5f 0%, #1a365d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-buyer {
    background: linear-gradient(135deg, #3d1e5f 0%, #4a1d6d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-manager {
    background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 11px;
    opacity: 0.8;
}

.message-sender {
    font-weight: 600;
}

.message-content {
    white-space: pre-wrap;
    line-height: 1.4;
}

/* Media in messages */
.media-photo {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 4px;
    display: block;
}

.media-video {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 4px;
    display: block;
}

.media-sticker {
    max-width: 150px;
    max-height: 150px;
    display: block;
}

.media-doc-link {
    display: inline-block;
    margin-top: 4px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    color: #93c5fd;
    text-decoration: none;
    font-size: 13px;
    transition: background 0.2s;
}

.message-manager .media-doc-link {
    color: #e0d4ff;
}

.media-doc-link:hover {
    background: rgba(255,255,255,0.18);
}

/* Fullscreen overlay */
.media-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.media-overlay img {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    border-radius: 4px;
}

/* Empty/Loading states */
.empty, .loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

/* Actions Row */
.actions-card .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
}

.actions-card select {
    min-width: 200px;
}

/* Mobile Responsive */
@media (max-width: 1024px) {
    .chats-container {
        grid-template-columns: 1fr;
    }

    .chat-card {
        height: calc(100vh - 350px);
        min-height: 350px;
    }
}

@media (max-width: 768px) {
    .deal-detail-page {
        padding-bottom: 20px;
    }

    .deal-info-card .info-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .info-item {
        padding: 10px;
    }

    .info-item label {
        font-size: 11px;
    }

    .actions-card .actions-row {
        flex-direction: column;
    }

    .actions-card .actions-row select,
    .actions-card .actions-row .btn {
        width: 100%;
    }

    /* Show tabs on mobile */
    .chat-tabs {
        display: flex;
    }

    /* Hide inactive chat on mobile */
    .chats-container {
        display: block;
    }

    .chat-card {
        display: none;
        height: calc(100vh - 320px);
        min-height: 300px;
    }

    .chat-card.active {
        display: flex;
    }

    .chat-card-header h3 {
        font-size: 15px;
    }

    .chat-input {
        padding: 10px 12px;
    }

    .chat-input input {
        font-size: 16px; /* Prevents zoom on iOS */
    }

    .chat-input .btn {
        padding: 10px 12px;
    }

    .chat-input .btn-text {
        display: none;
    }

    .chat-input .btn-icon {
        display: inline;
        font-size: 18px;
    }

    .message {
        max-width: 90%;
        padding: 8px 12px;
    }

    .message-header {
        font-size: 10px;
    }

    .message-content {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .deal-info-card .info-grid {
        grid-template-columns: 1fr;
    }

    .chat-tab {
        padding: 10px 12px;
        font-size: 13px;
    }

    .chat-card {
        height: calc(100vh - 280px);
    }
}
</style>

<script>
const dealId = {{ deal_id }};
let refreshInterval;
let activeChat = 'seller';
let selectedFiles = { seller: null, buyer: null };
let replyTo = { seller: null, buyer: null };

document.addEventListener('DOMContentLoaded', () => {
    loadDeal();
    loadMessages();
    loadManagers();

    // Auto-refresh every 5 seconds
    refreshInterval = setInterval(loadMessages, 5000);

    // Mark first chat as active on mobile
    document.getElementById('sellerChatCard').classList.add('active');
});

async function loadDeal() {
    const response = await fetch(`/admin/deals/${dealId}/data`);
    const deal = await response.json();

    document.getElementById('dealStatus').textContent = deal.status;
    document.getElementById('dealStatus').className = `badge badge-${deal.status}`;
    document.getElementById('dealProduct').textContent = deal.product;
    document.getElementById('dealRegion').textContent = deal.region || '-';
    document.getElementById('dealBuyPrice').textContent = formatMoney(deal.buy_price);
    document.getElementById('dealSellPrice').textContent = formatMoney(deal.sell_price);
    document.getElementById('dealMargin').textContent = formatMoney(deal.margin);
    document.getElementById('dealProfit').textContent = deal.profit ? formatMoney(deal.profit) : '-';
    document.getElementById('dealManager').textContent = deal.manager_name || 'Не назначен';
    document.getElementById('dealInsight').textContent = deal.ai_insight || '-';

    // Deal details
    document.getElementById('sellerCity').textContent = deal.seller_city || '-';
    document.getElementById('sellerCondition').textContent = deal.seller_condition || '-';
    document.getElementById('sellerSpecs').textContent = deal.seller_specs || '-';
    document.getElementById('sellerPhone').textContent = deal.seller_phone || '-';
    document.getElementById('buyerPhone').textContent = deal.buyer_phone || '-';
    if (deal.target_sell_price) document.getElementById('targetSellPrice').value = deal.target_sell_price;
    if (deal.notes) document.getElementById('dealNotes').value = deal.notes;
}

async function saveDealDetails() {
    const data = {};
    const targetPrice = document.getElementById('targetSellPrice').value;
    const notes = document.getElementById('dealNotes').value;
    if (targetPrice) data.target_sell_price = parseFloat(targetPrice);
    if (notes !== undefined) data.notes = notes;

    const res = await fetch(`/admin/deals/${dealId}/update`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    if (res.ok) {
        loadDeal();
    } else {
        alert('Ошибка при сохранении');
    }
}

async function loadMessages() {
    const response = await fetch(`/admin/deals/${dealId}/messages`);
    const data = await response.json();

    // Render seller messages
    renderMessages('sellerMessages', data.seller_messages || [], 'seller');
    document.getElementById('sellerCount').textContent = `${(data.seller_messages || []).length} сообщений`;
    document.getElementById('sellerBadge').textContent = (data.seller_messages || []).length;

    // Render buyer messages
    renderMessages('buyerMessages', data.buyer_messages || [], 'buyer');
    document.getElementById('buyerCount').textContent = `${(data.buyer_messages || []).length} сообщений`;
    document.getElementById('buyerBadge').textContent = (data.buyer_messages || []).length;
}

function renderMessages(containerId, messages, chatTarget) {
    const container = document.getElementById(containerId);

    if (messages.length === 0) {
        container.innerHTML = '<div class="empty">Нет сообщений</div>';
        return;
    }

    const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

    container.innerHTML = messages.map(msg => {
        const replyRefHtml = renderReplyRef(msg);
        const replyBtnHtml = `<div class="message-actions"><button class="btn-reply" onclick="setReply('${chatTarget}', ${msg.id}, '${escapeAttr(msg.sender_name)}', '${escapeAttr(truncate(msg.content, 60))}')">&#8617; Ответить</button></div>`;
        return `
            <div class="message message-${msg.role}" data-msg-id="${msg.id}">
                ${replyRefHtml}
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(msg.sender_name)}</span>
                    <span class="message-time">${formatTime(msg.created_at)}</span>
                </div>
                <div class="message-content">${renderMessageContent(msg)}</div>
                ${replyBtnHtml}
            </div>
        `;
    }).join('');

    if (wasScrolledToBottom) {
        container.scrollTop = container.scrollHeight;
    }
}

function renderReplyRef(msg) {
    if (!msg.reply_to_sender_name || !msg.reply_to_content) return '';
    const content = msg.reply_to_content.replace(/\[фото\]|\[видео\]|\[документ\]/, function(m) {
        return {'[фото]': 'Фото', '[видео]': 'Видео', '[документ]': 'Документ'}[m] || m;
    });
    let roleClass = '';
    const sn = msg.reply_to_sender_name;
    if (sn === 'Продавец') roleClass = 'reply-from-seller';
    else if (sn === 'Покупатель') roleClass = 'reply-from-buyer';
    else if (sn === 'Ассистент') roleClass = 'reply-from-ai';
    else roleClass = 'reply-from-manager';
    return `<div class="message-reply-ref ${roleClass}">
        <span class="reply-ref-sender">${escapeHtml(msg.reply_to_sender_name)}</span>
        <span class="reply-ref-text">${escapeHtml(content)}</span>
    </div>`;
}

function renderMessageContent(msg) {
    const mediaUrl = `/admin/deals/${dealId}/media/${msg.id}`;

    if (msg.media_type === 'photo') {
        const caption = (msg.content && msg.content !== '[фото]')
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        return caption + `<img src="${mediaUrl}" loading="lazy" class="media-photo" onclick="openFullscreen(this.src)" alt="Фото">`;
    }
    if (msg.media_type === 'video') {
        const caption = (msg.content && msg.content !== '[видео]')
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        return caption + `<video controls preload="none" class="media-video"><source src="${mediaUrl}" type="video/mp4"></video>`;
    }
    if (msg.media_type === 'document') {
        const isPlaceholder = !msg.content || msg.content === '[документ]' || msg.content.startsWith('[документ:') || msg.content.startsWith('[');
        const caption = !isPlaceholder
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        const docName = msg.file_name || 'Скачать документ';
        const ext = docName.includes('.') ? docName.split('.').pop().toLowerCase() : '';
        const icons = {'pdf': '\uD83D\uDCC4', 'doc': '\uD83D\uDCC3', 'docx': '\uD83D\uDCC3', 'xls': '\uD83D\uDCCA', 'xlsx': '\uD83D\uDCCA', 'zip': '\uD83D\uDCE6', 'rar': '\uD83D\uDCE6'};
        const icon = icons[ext] || '\uD83D\uDCCE';
        return caption + `<a href="${mediaUrl}" target="_blank" class="media-doc-link">${icon} ${escapeHtml(docName)}</a>`;
    }
    if (msg.media_type === 'sticker') {
        return `<img src="${mediaUrl}" loading="lazy" class="media-sticker" alt="Стикер">`;
    }
    return escapeHtml(msg.content);
}

// Reply functionality
function setReply(target, msgId, senderName, text) {
    replyTo[target] = { id: msgId, sender: senderName, text: text };
    document.getElementById(`${target}ReplyPreview`).style.display = 'flex';
    document.getElementById(`${target}ReplySender`).textContent = senderName;
    document.getElementById(`${target}ReplyText`).textContent = text;
    document.getElementById(`${target}MessageInput`).focus();
}

function cancelReply(target) {
    replyTo[target] = null;
    document.getElementById(`${target}ReplyPreview`).style.display = 'none';
}

// File upload functionality
function handleFileSelect(target, input) {
    const file = input.files[0];
    if (!file) return;

    if (file.size > 50 * 1024 * 1024) {
        alert('Файл слишком большой (макс. 50 МБ)');
        input.value = '';
        return;
    }

    selectedFiles[target] = file;
    const preview = document.getElementById(`${target}FilePreview`);
    const nameEl = document.getElementById(`${target}FileName`);
    nameEl.textContent = `\uD83D\uDCCE ${file.name} (${formatFileSize(file.size)})`;
    preview.style.display = 'flex';
}

function clearFileSelection(target) {
    selectedFiles[target] = null;
    document.getElementById(`${target}FileInput`).value = '';
    document.getElementById(`${target}FilePreview`).style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' Б';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' КБ';
    return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
}

async function sendFileMessage(target) {
    const file = selectedFiles[target];
    if (!file) return;

    const inputId = target === 'seller' ? 'sellerMessageInput' : 'buyerMessageInput';
    const input = document.getElementById(inputId);
    const caption = input.value.trim();

    const chatInput = input.closest('.chat-input');
    const btn = chatInput.querySelector('.btn-primary');
    btn.disabled = true;

    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('target', target);
        formData.append('caption', caption);
        if (replyTo[target]) {
            formData.append('reply_to_msg_id', replyTo[target].id);
        }

        const response = await fetch(`/admin/deals/${dealId}/send-file`, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            clearFileSelection(target);
            cancelReply(target);
            input.value = '';
            loadMessages();
        } else {
            const data = await response.json();
            alert(data.detail || 'Ошибка отправки файла');
        }
    } catch (e) {
        alert('Ошибка сети при отправке файла');
    } finally {
        btn.disabled = false;
    }
}

async function loadManagers() {
    const response = await fetch('/admin/managers/list?active_only=true');
    const data = await response.json();

    const select = document.getElementById('managerSelect');
    data.items.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.display_name;
        select.appendChild(option);
    });
}

async function assignManager() {
    const managerId = document.getElementById('managerSelect').value;
    if (!managerId) return;

    await fetch(`/admin/deals/${dealId}/assign`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manager_id: parseInt(managerId) })
    });
    loadDeal();
}

async function sendMessage(target) {
    // If file is selected, send file instead
    if (selectedFiles[target]) {
        return sendFileMessage(target);
    }

    const inputId = target === 'seller' ? 'sellerMessageInput' : 'buyerMessageInput';
    const input = document.getElementById(inputId);
    const content = input.value.trim();
    if (!content) return;

    const chatInput = input.closest('.chat-input');
    const btn = chatInput.querySelector('.btn-primary');
    btn.disabled = true;

    try {
        const body = { content, target };
        if (replyTo[target]) {
            body.reply_to_msg_id = replyTo[target].id;
        }
        await fetch(`/admin/deals/${dealId}/message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        input.value = '';
        cancelReply(target);
        loadMessages();
    } finally {
        btn.disabled = false;
    }
}

async function closeDeal(status) {
    const resolution = prompt('Комментарий к закрытию (опционально):');

    await fetch(`/admin/deals/${dealId}/close`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, resolution })
    });
    loadDeal();
}

async function deleteDeal() {
    if (!confirm('Удалить сделку и все связанные переговоры? Это действие необратимо.')) return;

    const res = await fetch(`/admin/deals/${dealId}`, { method: 'DELETE' });
    if (res.ok) {
        window.location.href = '/admin/deals';
    } else {
        alert('Ошибка при удалении сделки');
    }
}

function switchChat(chat) {
    activeChat = chat;

    // Update tabs
    document.querySelectorAll('.chat-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.chat === chat);
    });

    // Update chat cards
    document.getElementById('sellerChatCard').classList.toggle('active', chat === 'seller');
    document.getElementById('buyerChatCard').classList.toggle('active', chat === 'buyer');
}

function openFullscreen(src) {
    const overlay = document.getElementById('mediaOverlay');
    const img = document.getElementById('mediaOverlayImg');
    img.src = src;
    overlay.style.display = 'flex';
}

function closeFullscreen() {
    document.getElementById('mediaOverlay').style.display = 'none';
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        maximumFractionDigits: 0
    }).format(value);
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();

    if (isToday) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }) +
           ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeAttr(text) {
    return text.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
}

function truncate(text, len) {
    if (!text) return '';
    return text.length > len ? text.substring(0, len) + '...' : text;
}

// Handle Enter key for sending messages
document.getElementById('sellerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('seller');
});

document.getElementById('buyerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('buyer');
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
{% endblock %}
