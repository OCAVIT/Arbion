{% extends "admin/base.html" %}

{% block page_title %}Заявки{% endblock %}

{% block content %}
<!-- Filters -->
<div class="filters-bar">
    <select id="typeFilter" onchange="loadOrders()">
        <option value="">Все типы</option>
        <option value="buy">Покупка</option>
        <option value="sell">Продажа</option>
    </select>
    <input type="text" id="productFilter" placeholder="Товар..." onkeyup="loadOrders()">
    <input type="text" id="regionFilter" placeholder="Регион..." onkeyup="loadOrders()">
    <label class="checkbox-label">
        <input type="checkbox" id="activeOnly" checked onchange="loadOrders()">
        Только активные
    </label>
</div>

<!-- Orders Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Тип</th>
                <th>Товар</th>
                <th>Цена</th>
                <th>Объём</th>
                <th>Регион</th>
                <th class="hide-mobile">Чат</th>
                <th>Дата</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="ordersTableBody">
            <tr><td colspan="9" class="loading">Загрузка...</td></tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination"></div>

<script>
let currentPage = 1;

document.addEventListener('DOMContentLoaded', loadOrders);

async function loadOrders() {
    const type = document.getElementById('typeFilter').value;
    const product = document.getElementById('productFilter').value;
    const region = document.getElementById('regionFilter').value;
    const activeOnly = document.getElementById('activeOnly').checked;

    const params = new URLSearchParams({
        page: currentPage,
        per_page: 20,
        active_only: activeOnly
    });
    if (type) params.append('type', type);
    if (product) params.append('product', product);
    if (region) params.append('region', region);

    const response = await fetch(`/admin/orders/list?${params}`);
    const data = await response.json();

    renderOrders(data.items);
    renderPagination(data.total, data.page, data.pages);
}

function formatVolume(order) {
    if (order.volume_numeric && order.unit) {
        return `${parseFloat(order.volume_numeric)} ${escapeHtml(order.unit)}`;
    }
    if (order.quantity) return escapeHtml(order.quantity);
    return '-';
}

function formatPrice(order) {
    if (!order.price) return '-';
    let s = formatMoney(order.price);
    if (order.unit) s += '/' + escapeHtml(order.unit);
    return s;
}

function renderOrders(orders) {
    const tbody = document.getElementById('ordersTableBody');

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">Нет заявок</td></tr>';
        return;
    }

    tbody.innerHTML = orders.map(order => `
        <tr>
            <td>${order.id}</td>
            <td><span class="badge badge-${order.order_type}">${order.order_type === 'buy' ? 'Покупка' : 'Продажа'}</span></td>
            <td>${escapeHtml(order.product)}${order.niche ? ` <span class="niche-tag">${escapeHtml(order.niche)}</span>` : ''}</td>
            <td>${formatPrice(order)}</td>
            <td>${formatVolume(order)}</td>
            <td>${order.region || '-'}</td>
            <td class="hide-mobile">${order.chat_title || '-'}</td>
            <td>${formatDate(order.created_at)}</td>
            <td class="actions">
                <button onclick="deleteOrder(${order.id})" class="btn btn-sm btn-danger">Удалить</button>
            </td>
        </tr>
    `).join('');
}

async function deleteOrder(id) {
    if (!confirm('Удалить заявку навсегда?')) return;
    const res = await fetch(`/admin/orders/${id}`, { method: 'DELETE' });
    if (!res.ok) {
        const data = await res.json();
        alert(data.detail || 'Ошибка при удалении');
        return;
    }
    loadOrders();
}

function renderPagination(total, page, pages) {
    const container = document.getElementById('pagination');
    if (pages <= 1) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    for (let i = 1; i <= Math.min(pages, 10); i++) {
        html += `<button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}" onclick="goToPage(${i})">${i}</button>`;
    }
    container.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadOrders();
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('ru-RU');
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<style>
.niche-tag {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
    background-color: var(--accent-soft, rgba(99,102,241,0.1));
    color: var(--accent, #818cf8);
    margin-left: 4px;
    vertical-align: middle;
}

@media (max-width: 768px) {
    .hide-mobile {
        display: none;
    }

    .data-table {
        font-size: 13px;
    }

    .data-table th,
    .data-table td {
        padding: 8px 6px;
    }

    .filters-bar {
        flex-direction: column;
        gap: 8px;
    }

    .filters-bar select,
    .filters-bar input[type="text"] {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .data-table {
        font-size: 12px;
    }

    .data-table th,
    .data-table td {
        padding: 6px 4px;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 11px;
    }
}
</style>
{% endblock %}
