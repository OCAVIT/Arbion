{% extends "admin/base.html" %}

{% block page_title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏{% endblock %}

{% block header_actions %}
<button onclick="showAddSeedModal()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å seed-–∑–∞–ø—Ä–æ—Å</button>
{% endblock %}

{% block content %}
<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-item">
        <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
        <span class="stat-value text-success" id="activeChats">-</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">–ù–∞ –∏—Å–ø—ã—Ç–∞–Ω–∏–∏:</span>
        <span class="stat-value text-warning" id="probationChats">-</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">–ü–æ–∫–∏–Ω—É—Ç–æ:</span>
        <span class="stat-value text-muted" id="leftChats">-</span>
    </div>
    <div class="stat-item">
        <span class="stat-label">–¶–µ–ª—å:</span>
        <input type="number" id="targetInput" class="stat-input" min="0" max="10000">
        <button onclick="saveTarget()" class="btn btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<!-- Filters -->
<div class="filters-bar">
    <select id="statusFilter" onchange="loadChats()">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
        <option value="probation">–ù–∞ –∏—Å–ø—ã—Ç–∞–Ω–∏–∏</option>
        <option value="left">–ü–æ–∫–∏–Ω—É—Ç—ã–µ</option>
        <option value="blacklisted">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
    </select>
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." onkeyup="loadChats()">
    <select id="sortBy" onchange="loadChats()">
        <option value="useful_ratio">–ü–æ –ø–æ–ª–µ–∑–Ω–æ—Å—Ç–∏</option>
        <option value="orders_found">–ü–æ –∑–∞—è–≤–∫–∞–º</option>
        <option value="deals_created">–ü–æ —Å–¥–µ–ª–∫–∞–º</option>
        <option value="joined_at">–ü–æ –¥–∞—Ç–µ</option>
    </select>
</div>

<!-- Help tooltips -->
<div class="help-bar">
    <span class="help-item" title="–ê–∫—Ç–∏–≤–Ω—ã–µ ‚Äî –±–æ—Ç —Å–æ—Å—Ç–æ–∏—Ç –≤ —á–∞—Ç–µ –∏ –ø–∞—Ä—Å–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</span>
    <span class="help-item" title="–ù–∞ –∏—Å–ø—ã—Ç–∞–Ω–∏–∏ ‚Äî –Ω–µ–¥–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ–∑–Ω–æ—Å—Ç—å">‚è≥ –ù–∞ –∏—Å–ø—ã—Ç–∞–Ω–∏–∏</span>
    <span class="help-item" title="–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å ‚Äî % —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏ –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞">üìä –ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å</span>
    <span class="help-item" title="Seed-–∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–∏—Å–∫–æ–≤–∞—è —Ñ—Ä–∞–∑–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤ –≤ Telegram">üîç Seed-–∑–∞–ø—Ä–æ—Å</span>
</div>

<!-- Chats Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–ü–æ–ª–µ–∑–Ω–æ—Å—Ç—å</th>
                <th>–ó–∞—è–≤–æ–∫</th>
                <th>–°–¥–µ–ª–æ–∫</th>
                <th>–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è</th>
                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="chatsTableBody">
            <tr><td colspan="9" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination"></div>

<!-- Add Seed Modal -->
<div id="seedModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–î–æ–±–∞–≤–∏—Ç—å seed-–∑–∞–ø—Ä–æ—Å</h3>
            <button onclick="closeSeedModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</label>
                <input type="text" id="seedQuery" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫—É–ø–∏—Ç—å iPhone –ú–æ—Å–∫–≤–∞">
                <small class="form-hint">–ë–æ—Ç –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å —á–∞—Ç—ã –≤ Telegram –ø–æ —ç—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å—É –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç—É–ø–∞—Ç—å –≤ –Ω–∏—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeSeedModal()" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="addSeed()" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
let currentPage = 1;

document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadChats();
});

async function loadStats() {
    const response = await fetch('/api/admin/chats/stats');
    const data = await response.json();

    document.getElementById('activeChats').textContent = data.active_chats;
    document.getElementById('probationChats').textContent = data.probation_chats;
    document.getElementById('leftChats').textContent = data.left_chats;
    document.getElementById('targetInput').value = data.target_chat_count;
}

async function loadChats() {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;
    const sortBy = document.getElementById('sortBy').value;

    const params = new URLSearchParams({
        page: currentPage,
        per_page: 20,
        sort_by: sortBy,
        sort_order: 'desc'
    });
    if (status) params.append('status', status);
    if (search) params.append('search', search);

    const response = await fetch(`/api/admin/chats/list?${params}`);
    const data = await response.json();

    renderChats(data.items);
    renderPagination(data.total, data.page, data.pages);
}

function getStatusLabel(status) {
    const labels = {
        'active': '–ê–∫—Ç–∏–≤–Ω—ã–π',
        'probation': '–ù–∞ –∏—Å–ø—ã—Ç–∞–Ω–∏–∏',
        'left': '–ü–æ–∫–∏–Ω—É—Ç',
        'blacklisted': '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
    };
    return labels[status] || status;
}

function renderChats(chats) {
    const tbody = document.getElementById('chatsTableBody');

    if (chats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty">–ù–µ—Ç —á–∞—Ç–æ–≤</td></tr>';
        return;
    }

    tbody.innerHTML = chats.map(chat => `
        <tr>
            <td>${escapeHtml(chat.title)}</td>
            <td>${chat.member_count}</td>
            <td><span class="badge badge-${chat.status}">${getStatusLabel(chat.status)}</span></td>
            <td title="–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π">${chat.useful_ratio.toFixed(1)}%</td>
            <td>${chat.orders_found}</td>
            <td>${chat.deals_created}</td>
            <td>${formatDate(chat.joined_at)}</td>
            <td>${chat.source}</td>
            <td class="actions">
                ${chat.status !== 'left' ? `<button onclick="leaveChat(${chat.id})" class="btn btn-sm btn-outline">–ü–æ–∫–∏–Ω—É—Ç—å</button>` : ''}
                ${chat.status !== 'blacklisted' ? `<button onclick="blacklistChat(${chat.id})" class="btn btn-sm btn-danger">–ë–ª–æ–∫</button>` : ''}
            </td>
        </tr>
    `).join('');
}

async function saveTarget() {
    const target = document.getElementById('targetInput').value;
    await fetch('/api/admin/chats/target?target=' + target, { method: 'POST' });
    loadStats();
}

async function leaveChat(id) {
    if (!confirm('–ü–æ–∫–∏–Ω—É—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
    await fetch(`/api/admin/chats/${id}/leave`, { method: 'POST' });
    loadChats();
    loadStats();
}

async function blacklistChat(id) {
    if (!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
    await fetch(`/api/admin/chats/${id}/blacklist`, { method: 'POST' });
    loadChats();
    loadStats();
}

function showAddSeedModal() {
    document.getElementById('seedModal').style.display = 'flex';
}

function closeSeedModal() {
    document.getElementById('seedModal').style.display = 'none';
    document.getElementById('seedQuery').value = '';
}

async function addSeed() {
    const query = document.getElementById('seedQuery').value.trim();
    if (!query) return;

    await fetch('/api/admin/seeds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    });
    closeSeedModal();
}

function renderPagination(total, page, pages) {
    // Simple pagination
    const container = document.getElementById('pagination');
    if (pages <= 1) {
        container.innerHTML = '';
        return;
    }

    let html = '';
    for (let i = 1; i <= pages; i++) {
        html += `<button class="btn btn-sm ${i === page ? 'btn-primary' : 'btn-outline'}" onclick="goToPage(${i})">${i}</button>`;
    }
    container.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadChats();
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('ru-RU');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
