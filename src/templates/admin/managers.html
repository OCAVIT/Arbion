{% extends "admin/base.html" %}

{% block page_title %}–ú–µ–Ω–µ–¥–∂–µ—Ä—ã{% endblock %}

{% block header_actions %}
<button onclick="showCreateModal()" class="btn btn-primary">+ –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
{% endblock %}

{% block content %}
<!-- Managers Table -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>–ò–º—è</th>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</th>
                <th>–í—ã–∏–≥—Ä–∞–Ω–æ</th>
                <th>–ü—Ä–æ–∏–≥—Ä–∞–Ω–æ</th>
                <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody id="managersTableBody">
            <tr><td colspan="10" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
    </table>
</div>

<!-- Help tooltips -->
<div class="help-bar">
    <span class="help-item" title="–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –∑–∞–∫—Ä—ã—Ç—ã—Ö">üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
    <span class="help-item" title="–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞">üí∞ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</span>
    <span class="help-item" title="–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É.">üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞</span>
</div>

<!-- Manager Link Modal -->
<div id="linkModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞</h3>
            <button onclick="closeLinkModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: <strong id="linkManagerName"></strong></p>
            <div class="form-group">
                <label>–°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞</label>
                <div class="form-inline">
                    <input type="text" id="managerLink" readonly>
                    <button onclick="copyLink()" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <small class="form-hint">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤–º–µ—Å—Ç–µ —Å –ø–∞—Ä–æ–ª–µ–º. –ü–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –æ–Ω —Å–º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</small>
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <button onclick="regenerateToken()" class="btn btn-outline btn-sm">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É</button>
                <small class="form-hint" style="margin-top: 8px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ, –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞. –°—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeLinkModal()" class="btn btn-outline">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- Create Manager Modal -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°–æ–∑–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
            <button onclick="closeCreateModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>–õ–æ–≥–∏–Ω</label>
                <input type="text" id="newUsername" required placeholder="–õ–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã">
                <small class="form-hint">–õ–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã.</small>
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="newPassword" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                <small class="form-hint">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.</small>
            </div>
            <div class="form-group">
                <label>–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                <input type="text" id="newDisplayName" required placeholder="–ò–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ">
                <small class="form-hint">–≠—Ç–æ –∏–º—è –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –æ—Ç—á—ë—Ç–∞—Ö.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeCreateModal()" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="createManager()" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h3>
            <button onclick="closeResetPasswordModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: <strong id="resetManagerName"></strong></p>
            <div class="form-group">
                <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                <input type="password" id="resetNewPassword" required minlength="6" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
                <small class="form-hint">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ —Å–æ–æ–±—â–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä—É.</small>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeResetPasswordModal()" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="confirmResetPassword()" class="btn btn-primary">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadManagers);

async function loadManagers() {
    try {
        const response = await fetch('/admin/managers/list');
        if (!response.ok) throw new Error('Failed to load managers');
        const data = await response.json();
        renderManagers(data.items || []);
    } catch (error) {
        console.error('Error loading managers:', error);
        document.getElementById('managersTableBody').innerHTML =
            '<tr><td colspan="10" class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    }
}

function renderManagers(managers) {
    const tbody = document.getElementById('managersTableBody');

    if (managers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="empty">–ù–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</td></tr>';
        return;
    }

    tbody.innerHTML = managers.map(m => `
        <tr>
            <td><a href="/admin/managers/${m.id}">${escapeHtml(m.display_name)}</a></td>
            <td>${escapeHtml(m.username)}</td>
            <td>${m.active_deals_count}</td>
            <td class="text-success">${m.won_deals_count}</td>
            <td class="text-danger">${m.lost_deals_count}</td>
            <td>${m.conversion_rate}%</td>
            <td>${formatMoney(m.avg_deal_value)}</td>
            <td>${m.last_active_at ? formatDate(m.last_active_at) : '-'}</td>
            <td><span class="badge badge-${m.is_active ? 'active' : 'inactive'}">${m.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span></td>
            <td class="actions">
                <button onclick="showManagerLink(${m.id}, '${escapeHtml(m.display_name)}', '${m.invite_token || ''}')" class="btn btn-sm btn-primary">–°—Å—ã–ª–∫–∞</button>
                ${m.is_active ?
                    `<button onclick="deactivateManager(${m.id})" class="btn btn-sm btn-outline">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>` :
                    `<button onclick="activateManager(${m.id})" class="btn btn-sm btn-primary">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`
                }
                <button onclick="resetPassword(${m.id}, '${escapeHtml(m.display_name)}')" class="btn btn-sm btn-outline">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</button>
            </td>
        </tr>
    `).join('');
}

function showCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}

function closeCreateModal() {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('newDisplayName').value = '';
}

async function createManager() {
    const username = document.getElementById('newUsername').value;
    const password = document.getElementById('newPassword').value;
    const displayName = document.getElementById('newDisplayName').value;

    if (!username || !password || !displayName) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }

    const response = await fetch('/admin/managers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, display_name: displayName })
    });

    if (response.ok) {
        closeCreateModal();
        loadManagers();
    } else {
        const data = await response.json();
        alert(data.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
    }
}

async function deactivateManager(id) {
    if (!confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞?')) return;
    await fetch(`/admin/managers/${id}`, { method: 'DELETE' });
    loadManagers();
}

async function activateManager(id) {
    await fetch(`/admin/managers/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: true })
    });
    loadManagers();
}

let currentResetManagerId = null;
let currentLinkManagerId = null;

function showManagerLink(id, displayName, inviteToken) {
    currentLinkManagerId = id;
    document.getElementById('linkManagerName').textContent = displayName || '–º–µ–Ω–µ–¥–∂–µ—Ä–∞';

    const baseUrl = window.location.origin;
    const link = `${baseUrl}/api/auth/m/${inviteToken}`;
    document.getElementById('managerLink').value = link;

    document.getElementById('linkModal').style.display = 'flex';
}

function closeLinkModal() {
    document.getElementById('linkModal').style.display = 'none';
    currentLinkManagerId = null;
}

function copyLink() {
    const linkInput = document.getElementById('managerLink');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(linkInput.value).then(() => {
        showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
    }).catch(() => {
        // Fallback for older browsers
        document.execCommand('copy');
        showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
    });
}

async function regenerateToken() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –°—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.')) return;

    try {
        const response = await fetch(`/admin/managers/${currentLinkManagerId}/regenerate-token`, {
            method: 'POST'
        });

        if (response.ok) {
            const data = await response.json();
            const baseUrl = window.location.origin;
            document.getElementById('managerLink').value = `${baseUrl}/api/auth/m/${data.invite_token}`;
            showNotification('–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞', 'success');
            loadManagers(); // Refresh the table
        } else {
            const data = await response.json();
            showNotification(data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
    }
}

function resetPassword(id, displayName) {
    currentResetManagerId = id;
    document.getElementById('resetManagerName').textContent = displayName || '–º–µ–Ω–µ–¥–∂–µ—Ä–∞';
    document.getElementById('resetNewPassword').value = '';
    document.getElementById('resetPasswordModal').style.display = 'flex';
}

function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
    currentResetManagerId = null;
}

async function confirmResetPassword() {
    const newPassword = document.getElementById('resetNewPassword').value;
    if (!newPassword || newPassword.length < 6) {
        showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return;
    }

    try {
        const response = await fetch(`/admin/managers/${currentResetManagerId}/reset-password?new_password=${encodeURIComponent(newPassword)}`, {
            method: 'POST'
        });

        if (response.ok) {
            showNotification('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω. –°–æ–æ–±—â–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä—É.', 'success');
            closeResetPasswordModal();
        } else {
            const data = await response.json();
            showNotification(data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
    }
}

function formatDate(dateStr) { return new Date(dateStr).toLocaleString('ru-RU'); }
function formatMoney(value) { return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value); }
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

// Notification system
function showNotification(message, type = 'info') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="notification-close">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}
</script>
{% endblock %}
