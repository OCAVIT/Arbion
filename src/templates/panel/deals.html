{% extends "panel/base.html" %}

{% block page_title %}–ú–æ–∏ —Å–¥–µ–ª–∫–∏{% endblock %}

{% block content %}
<!-- Help tooltips -->
<div class="help-bar">
    <span class="help-item" title="–¢—ë–ø–ª–∞—è ‚Äî AI –ø—Ä–æ–≤—ë–ª –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –ø—Ä–æ–¥–∞–≤–µ—Ü –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω">üî• –¢—ë–ø–ª–∞—è</span>
    <span class="help-item" title="–í —Ä–∞–±–æ—Ç–µ ‚Äî —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤–∞–º –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è">üë§ –í —Ä–∞–±–æ—Ç–µ</span>
    <span class="help-item" title="–í—ã–∏–≥—Ä–∞–Ω–∞ ‚Äî —Å–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞">‚úÖ –í—ã–∏–≥—Ä–∞–Ω–∞</span>
    <span class="help-item" title="–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞ ‚Äî —Å–¥–µ–ª–∫–∞ –Ω–µ —Å–æ—Å—Ç–æ—è–ª–∞—Å—å">‚ùå –ü—Ä–æ–∏–≥—Ä–∞–Ω–∞</span>
</div>

<!-- Deals Grid -->
<div class="deals-grid" id="dealsGrid">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', loadDeals);

async function loadDeals() {
    try {
        const response = await fetch('/panel/deals/list?include_pool=true');
        if (!response.ok) throw new Error('Failed to load deals');
        const data = await response.json();

        const container = document.getElementById('dealsGrid');

        if (!data.items || data.items.length === 0) {
            container.innerHTML = '<div class="empty">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</div>';
            return;
        }

    container.innerHTML = data.items.map(deal => `
        <div class="deal-card ${deal.can_take ? 'deal-card-warm' : ''}">
            <div class="deal-header">
                <span class="deal-product">${escapeHtml(deal.product)}</span>
                <span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span>
            </div>
            <div class="deal-price">${formatMoney(deal.sell_price)}${deal.unit ? '/' + escapeHtml(deal.unit) : ''}</div>
            ${deal.volume ? `<div class="deal-volume">${escapeHtml(deal.volume)}</div>` : ''}
            <div class="deal-region">${deal.region || '–†–µ–≥–∏–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
            ${deal.status === 'won' && deal.commission ? `
                <div class="deal-commission">
                    <span class="commission-label">–ö–æ–º–∏—Å—Å–∏—è:</span>
                    <span class="commission-value text-success">${formatMoney(deal.commission)}</span>
                </div>
            ` : ''}
            <div class="deal-meta">
                <span>–°–æ–æ–±—â–µ–Ω–∏–π: ${deal.messages_count}</span>
            </div>
            <div class="deal-actions">
                ${deal.status === 'cold' && deal.can_take ?
                    `<a href="/panel/leads/${deal.id}" class="btn btn-primary btn-sm">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>` :
                    deal.can_take && deal.status === 'warm' ?
                        `<button onclick="takeDeal(${deal.id})" class="btn btn-success btn-sm">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>` :
                        deal.negotiation_id ?
                            `<a href="/panel/chat/${deal.negotiation_id}" class="btn btn-primary btn-sm">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>` :
                            '<span class="text-muted">–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏</span>'
                }
            </div>
        </div>
    `).join('');
    } catch (error) {
        console.error('Error loading deals:', error);
        document.getElementById('dealsGrid').innerHTML = '<div class="empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
    }
}

async function takeDeal(dealId) {
    try {
        const response = await fetch(`/panel/deals/${dealId}/take`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            showNotification('–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É!', 'success');
            loadDeals();
        } else {
            const errorMessages = {
                'deal_not_found': '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –µ—ë —É–∂–µ –≤–∑—è–ª –¥—Ä—É–≥–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä.',
                'deal_already_taken': '–≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.',
                'max_deals_reached': '–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫. –ó–∞–∫—Ä–æ–π—Ç–µ —Ç–µ–∫—É—â–∏–µ —Å–¥–µ–ª–∫–∏, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –Ω–æ–≤—ã–µ.',
                'deal_not_warm': '–≠—Ç–∞ —Å–¥–µ–ª–∫–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É.'
            };
            showNotification(errorMessages[data.detail] || data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å —Å–¥–µ–ª–∫—É.', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
    }
}

function getStatusLabel(status) {
    const labels = {
        'cold': '–•–æ–ª–æ–¥–Ω–∞—è',
        'in_progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        'warm': '–¢—ë–ø–ª–∞—è',
        'handed_to_manager': '–í —Ä–∞–±–æ—Ç–µ',
        'won': '–í—ã–∏–≥—Ä–∞–Ω–∞',
        'lost': '–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞'
    };
    return labels[status] || status;
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyContact(contact) {
    navigator.clipboard.writeText(contact).then(() => {
        showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
    }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = contact;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showNotification('–ö–æ–Ω—Ç–∞–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
    });
}

// Notification system
function showNotification(message, type = 'info') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="notification-close">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}
</script>

<style>
.deal-volume {
    font-size: 13px;
    color: var(--text-secondary, #94a3b8);
    margin-top: 2px;
}

@media (max-width: 768px) {
    .deals-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .deal-card {
        padding: 14px;
    }

    .deal-product {
        font-size: 14px;
    }

    .deal-price {
        font-size: 16px;
    }
}
</style>
{% endblock %}
