{% extends "panel/base.html" %}

{% block page_title %}Сделка{% endblock %}

{% block content %}
<div class="chat-page">
    <!-- Deal Info -->
    <div class="deal-info-bar">
        <div class="deal-info-item">
            <span class="deal-info-label">Товар:</span>
            <span class="deal-info-value" id="dealProduct">-</span>
        </div>
        <div class="deal-info-item">
            <span class="deal-info-label">Цена:</span>
            <span class="deal-info-value text-success" id="dealPrice">-</span>
        </div>
        <div class="deal-info-item">
            <span class="deal-info-label">Статус:</span>
            <span id="dealStatus" class="badge">-</span>
        </div>
    </div>

    <!-- Chat Tabs -->
    <div class="chat-tabs">
        <button class="chat-tab active" data-chat="seller" onclick="switchChat('seller')">
            Продавец
            <span class="chat-tab-badge" id="sellerBadge">0</span>
        </button>
        <button class="chat-tab" data-chat="buyer" onclick="switchChat('buyer')">
            Покупатель
            <span class="chat-tab-badge" id="buyerBadge">0</span>
        </button>
    </div>

    <!-- Chats Container -->
    <div class="chats-wrapper">
        <!-- Seller Chat -->
        <div class="chat-panel active" id="sellerChat">
            <div class="chat-messages" id="sellerMessages">
                <div class="loading">Загрузка...</div>
            </div>
            <div class="reply-preview" id="sellerReplyPreview" style="display:none">
                <div class="reply-preview-content">
                    <span class="reply-preview-sender" id="sellerReplySender"></span>
                    <span class="reply-preview-text" id="sellerReplyText"></span>
                </div>
                <button class="reply-preview-close" onclick="cancelReply('seller')">&times;</button>
            </div>
            <div class="file-preview" id="sellerFilePreview" style="display:none">
                <span class="file-preview-name" id="sellerFileName"></span>
                <button class="file-preview-remove" onclick="clearFileSelection('seller')">&times;</button>
            </div>
            <div class="chat-input-area" id="sellerInputArea">
                <button onclick="document.getElementById('sellerFileInput').click()" class="btn-attach" title="Прикрепить файл">&#128206;</button>
                <input type="file" id="sellerFileInput" style="display:none" onchange="handleFileSelect('seller', this)" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z">
                <input type="text" id="sellerMessageInput" placeholder="Написать продавцу...">
                <button onclick="sendMessage('seller')" class="btn btn-primary">
                    <span class="btn-text">Отправить</span>
                    <span class="btn-icon">&#10148;</span>
                </button>
            </div>
        </div>

        <!-- Buyer Chat -->
        <div class="chat-panel" id="buyerChat">
            <div class="chat-messages" id="buyerMessages">
                <div class="loading">Загрузка...</div>
            </div>
            <div class="reply-preview" id="buyerReplyPreview" style="display:none">
                <div class="reply-preview-content">
                    <span class="reply-preview-sender" id="buyerReplySender"></span>
                    <span class="reply-preview-text" id="buyerReplyText"></span>
                </div>
                <button class="reply-preview-close" onclick="cancelReply('buyer')">&times;</button>
            </div>
            <div class="file-preview" id="buyerFilePreview" style="display:none">
                <span class="file-preview-name" id="buyerFileName"></span>
                <button class="file-preview-remove" onclick="clearFileSelection('buyer')">&times;</button>
            </div>
            <div class="chat-input-area" id="buyerInputArea">
                <button onclick="document.getElementById('buyerFileInput').click()" class="btn-attach" title="Прикрепить файл">&#128206;</button>
                <input type="file" id="buyerFileInput" style="display:none" onchange="handleFileSelect('buyer', this)" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z">
                <input type="text" id="buyerMessageInput" placeholder="Написать покупателю...">
                <button onclick="sendMessage('buyer')" class="btn btn-primary">
                    <span class="btn-text">Отправить</span>
                    <span class="btn-icon">&#10148;</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Deal Details Panel -->
    <div class="card deal-details-card" id="dealDetailsCard" style="margin-top:12px;">
        <div class="card-header" style="cursor:pointer;" onclick="toggleDealDetails()">
            <h3>Детали сделки</h3>
            <span id="dealDetailsToggle" style="font-size:18px;">&#9660;</span>
        </div>
        <div class="card-body" id="dealDetailsBody" style="display:none;">
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Регион:</span>
                    <span class="detail-value" id="detailRegion">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Город продавца:</span>
                    <span class="detail-value" id="detailCity">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Состояние:</span>
                    <span class="detail-value" id="detailCondition">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Характеристики:</span>
                    <span class="detail-value" id="detailSpecs">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">AI Insight:</span>
                    <span class="detail-value" id="detailInsight">-</span>
                </div>
            </div>
            <div style="margin-top:12px;">
                <label style="display:block;margin-bottom:4px;color:var(--text-secondary);font-size:13px;">Заметки</label>
                <textarea id="dealNotes" rows="3" style="width:100%;resize:vertical;" placeholder="Заметки по сделке..."></textarea>
                <button onclick="saveNotes()" class="btn btn-primary btn-sm" style="margin-top:6px;">Сохранить заметки</button>
            </div>
        </div>
    </div>

    <!-- Commission Info (for closed WON deals) -->
    <div class="card" id="commissionCard" style="margin-top:12px;display:none;">
        <div class="card-body" style="text-align:center;">
            <div style="color:var(--text-secondary);font-size:13px;">Ваша комиссия по этой сделке</div>
            <div style="font-size:24px;font-weight:700;color:var(--success);margin-top:4px;" id="dealCommission">-</div>
        </div>
    </div>

    <!-- Close Actions -->
    <div class="chat-actions" id="chatActions">
        <button onclick="closeDeal('won')" class="btn btn-success">Закрыть (Успех)</button>
        <button onclick="closeDeal('lost')" class="btn btn-danger">Закрыть (Отказ)</button>
    </div>
</div>

<!-- Fullscreen media overlay -->
<div id="mediaOverlay" class="media-overlay" onclick="closeFullscreen()">
    <img id="mediaOverlayImg" src="" alt="Полный размер">
</div>

<style>
/* Chat Page Styles */
.chat-page {
    display: flex;
    flex-direction: column;
    height: calc(100vh - var(--header-height) - 32px);
    max-height: calc(100vh - var(--header-height) - 32px);
}

/* Deal Info Bar */
.deal-info-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    padding: 12px 16px;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    flex-shrink: 0;
}

.deal-info-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.deal-info-label {
    color: var(--text-secondary);
    font-size: 13px;
}

.deal-info-value {
    font-weight: 600;
}

/* Chat Tabs */
.chat-tabs {
    display: flex;
    margin-bottom: 12px;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    padding: 4px;
    gap: 4px;
    flex-shrink: 0;
}

.chat-tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 14px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.chat-tab:hover {
    background: var(--bg-hover);
}

.chat-tab.active {
    background: var(--success);
    color: white;
}

.chat-tab-badge {
    background: var(--danger, #ef4444);
    color: #fff;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    min-width: 24px;
    text-align: center;
}

.chat-tab.active .chat-tab-badge {
    background: rgba(255,255,255,0.25);
    color: white;
    font-weight: 700;
}

.chat-tab-badge.badge-zero {
    background: var(--bg-hover);
    color: var(--text-secondary);
    font-weight: 400;
}

.chat-tab.active .chat-tab-badge.badge-zero {
    background: rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.7);
}

/* Read indicator checkmark */
.message-read-indicator {
    font-size: 12px;
    opacity: 0.7;
    margin-left: 4px;
    letter-spacing: -2px;
}

/* Chats Wrapper */
.chats-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg-card);
    border-radius: var(--border-radius);
    min-height: 0;
}

/* Chat Panel */
.chat-panel {
    display: none;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}

.chat-panel.active {
    display: flex;
}

/* Chat Messages */
.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    -webkit-overflow-scrolling: touch;
}

/* Messages */
.message {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 16px;
    word-break: break-word;
}

.message-ai {
    background: var(--bg-secondary);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-seller {
    background: linear-gradient(135deg, #1e3a5f 0%, #1a365d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-buyer {
    background: linear-gradient(135deg, #3d1e5f 0%, #4a1d6d 100%);
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

.message-manager {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 11px;
    opacity: 0.8;
}

.message-sender {
    font-weight: 600;
}

.message-content {
    white-space: pre-wrap;
    line-height: 1.4;
}

/* Chat Input */
.chat-input-area {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
}

.chat-input-area input {
    flex: 1;
    min-width: 0;
    font-size: 16px; /* Prevents zoom on iOS */
}

.chat-input-area .btn {
    flex-shrink: 0;
    padding: 10px 16px;
}

.chat-input-area .btn-icon {
    display: none;
}

/* Chat Actions */
.chat-actions {
    display: flex;
    gap: 12px;
    margin-top: 12px;
    flex-shrink: 0;
}

.chat-actions .btn {
    flex: 1;
}

/* Deal Details */
.deal-details-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.detail-label {
    color: var(--text-secondary);
    font-size: 12px;
}

.detail-value {
    font-weight: 500;
    font-size: 14px;
}

@media (max-width: 480px) {
    .detail-grid {
        grid-template-columns: 1fr;
    }
}

/* Media in messages */
.media-photo {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 4px;
    display: block;
}

.media-video {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 4px;
    display: block;
}

.media-sticker {
    max-width: 150px;
    max-height: 150px;
    display: block;
}

.media-doc-link {
    display: inline-block;
    margin-top: 4px;
    padding: 8px 12px;
    background: rgba(255,255,255,0.08);
    border-radius: 8px;
    color: #93c5fd;
    text-decoration: none;
    font-size: 13px;
    transition: background 0.2s;
}

.message-manager .media-doc-link {
    color: #bbf7d0;
}

.media-doc-link:hover {
    background: rgba(255,255,255,0.15);
}

/* Reply reference in messages - Telegram-like */
.message-reply-ref {
    background: rgba(255, 255, 255, 0.06);
    border-left: 3px solid #34b7f1;
    padding: 5px 10px;
    margin-bottom: 6px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.message-reply-ref:hover {
    background: rgba(255, 255, 255, 0.12);
}

.message-reply-ref.reply-from-seller {
    border-left-color: #4fc3f7;
}

.message-reply-ref.reply-from-buyer {
    border-left-color: #ce93d8;
}

.message-reply-ref.reply-from-manager {
    border-left-color: #10b981;
}

.message-reply-ref.reply-from-ai {
    border-left-color: #ffa726;
}

.message-reply-ref .reply-ref-sender {
    font-weight: 600;
    font-size: 12px;
    color: #34b7f1;
}

.message-reply-ref.reply-from-seller .reply-ref-sender { color: #4fc3f7; }
.message-reply-ref.reply-from-buyer .reply-ref-sender { color: #ce93d8; }
.message-reply-ref.reply-from-manager .reply-ref-sender { color: #10b981; }
.message-reply-ref.reply-from-ai .reply-ref-sender { color: #ffa726; }

.message-reply-ref .reply-ref-text {
    opacity: 0.7;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    max-width: 250px;
}

/* Reply button */
.message-actions {
    display: flex;
    justify-content: flex-start;
    margin-top: 4px;
}

.btn-reply {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.4);
    font-size: 11px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    transition: all 0.2s;
}

.btn-reply:hover {
    color: rgba(255, 255, 255, 0.8);
    background: rgba(255, 255, 255, 0.08);
}

.message-manager .message-header {
    opacity: 1;
}

.message-manager .message-reply-ref {
    background: rgba(0, 0, 0, 0.2);
}

.message-manager .message-reply-ref:hover {
    background: rgba(0, 0, 0, 0.3);
}

.message-manager .message-reply-ref .reply-ref-text {
    opacity: 0.9;
}

.message-manager .message-reply-ref.reply-from-manager {
    border-left-color: #a7f3d0;
}

.message-manager .reply-from-manager .reply-ref-sender {
    color: #a7f3d0;
}

.message-manager .btn-reply {
    color: rgba(255, 255, 255, 0.7);
}

.message-manager .btn-reply:hover {
    color: #fff;
    background: rgba(0, 0, 0, 0.15);
}

/* Reply preview bar */
.reply-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: rgba(16, 185, 129, 0.1);
    border-left: 3px solid var(--success, #10b981);
    border-top: 1px solid var(--border-color);
    font-size: 13px;
    gap: 8px;
    flex-shrink: 0;
}

.reply-preview-content {
    flex: 1;
    min-width: 0;
    overflow: hidden;
}

.reply-preview-sender {
    font-weight: 600;
    font-size: 12px;
    display: block;
    color: var(--success, #10b981);
}

.reply-preview-text {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-secondary);
    font-size: 12px;
}

.reply-preview-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
    flex-shrink: 0;
}

/* File attach button */
.btn-attach {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    opacity: 0.6;
    transition: opacity 0.2s;
    flex-shrink: 0;
}

.btn-attach:hover {
    opacity: 1;
}

/* File preview bar */
.file-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: var(--bg-hover, rgba(255,255,255,0.05));
    border-bottom: 1px solid var(--border-color);
    font-size: 13px;
    gap: 8px;
}

.file-preview-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    min-width: 0;
}

.file-preview-remove {
    background: none;
    border: none;
    color: var(--danger, #ef4444);
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
    flex-shrink: 0;
}

/* Fullscreen overlay */
.media-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.media-overlay img {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    border-radius: 4px;
}

/* Empty/Loading states */
.empty, .loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .chat-page {
        height: calc(100vh - var(--header-height) - 16px);
    }

    .deal-info-bar {
        padding: 10px 12px;
        gap: 12px;
    }

    .deal-info-item {
        flex: 1 1 auto;
    }

    .deal-info-label {
        font-size: 12px;
    }

    .chat-tabs {
        margin-bottom: 8px;
    }

    .chat-tab {
        padding: 10px 12px;
        font-size: 13px;
    }

    .chat-messages {
        padding: 12px;
        gap: 10px;
    }

    .message {
        max-width: 90%;
        padding: 8px 12px;
    }

    .message-header {
        font-size: 10px;
    }

    .message-content {
        font-size: 14px;
    }

    .chat-input-area {
        padding: 10px 12px;
    }

    .chat-input-area .btn {
        padding: 10px 12px;
    }

    .chat-input-area .btn-text {
        display: none;
    }

    .chat-input-area .btn-icon {
        display: inline;
        font-size: 18px;
    }

    .chat-actions {
        flex-direction: column;
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .deal-info-bar {
        flex-direction: column;
        gap: 8px;
    }

    .deal-info-item {
        justify-content: space-between;
        width: 100%;
    }

    .chat-tab-badge {
        padding: 2px 6px;
        font-size: 11px;
    }
}
</style>

<script>
const negotiationId = {{ negotiation_id }};
let refreshInterval;
let activeChat = 'seller';
let dealClosed = false;

document.addEventListener('DOMContentLoaded', () => {
    loadMessages();
    refreshInterval = setInterval(loadMessages, 5000);
    // Mark initial active tab as read
    markRead(activeChat);
});

async function loadMessages() {
    const response = await fetch(`/panel/chat/${negotiationId}/messages`);
    const data = await response.json();

    // Update info
    document.getElementById('dealProduct').textContent = data.product;
    document.getElementById('dealPrice').textContent = formatMoney(data.sell_price);
    document.getElementById('dealStatus').textContent = getStatusLabel(data.deal_status);
    document.getElementById('dealStatus').className = `badge badge-${data.deal_status}`;

    // Populate deal details
    document.getElementById('detailRegion').textContent = data.region || '-';
    document.getElementById('detailCity').textContent = data.seller_city || '-';
    document.getElementById('detailCondition').textContent = data.seller_condition || '-';
    document.getElementById('detailSpecs').textContent = data.seller_specs || '-';
    document.getElementById('detailInsight').textContent = data.ai_insight || '-';
    if (data.notes) {
        document.getElementById('dealNotes').value = data.notes;
    }

    // Check if closed
    if (data.deal_status === 'won' || data.deal_status === 'lost') {
        dealClosed = true;
        document.getElementById('sellerInputArea').style.display = 'none';
        document.getElementById('buyerInputArea').style.display = 'none';
        document.getElementById('sellerFilePreview').style.display = 'none';
        document.getElementById('buyerFilePreview').style.display = 'none';
        document.getElementById('chatActions').style.display = 'none';
        clearInterval(refreshInterval);

        // Show commission for WON deals
        if (data.deal_status === 'won' && data.commission !== undefined && data.commission !== null) {
            document.getElementById('commissionCard').style.display = 'block';
            document.getElementById('dealCommission').textContent = formatMoney(data.commission);
        }
    }

    // Render seller messages
    const sellerMessages = data.seller_messages || [];
    renderMessages('sellerMessages', sellerMessages);

    // Render buyer messages
    const buyerMessages = data.buyer_messages || [];
    renderMessages('buyerMessages', buyerMessages);

    // Unread counts (only non-manager messages without read_at)
    const sellerUnread = sellerMessages.filter(m => m.role !== 'manager' && !m.read_at).length;
    const buyerUnread = buyerMessages.filter(m => m.role !== 'manager' && !m.read_at).length;

    const sellerBadgeEl = document.getElementById('sellerBadge');
    const buyerBadgeEl = document.getElementById('buyerBadge');

    if (sellerUnread > 0) {
        sellerBadgeEl.textContent = sellerUnread;
        sellerBadgeEl.classList.remove('badge-zero');
    } else {
        sellerBadgeEl.textContent = sellerMessages.length;
        sellerBadgeEl.classList.add('badge-zero');
    }

    if (buyerUnread > 0) {
        buyerBadgeEl.textContent = buyerUnread;
        buyerBadgeEl.classList.remove('badge-zero');
    } else {
        buyerBadgeEl.textContent = buyerMessages.length;
        buyerBadgeEl.classList.add('badge-zero');
    }

    // Auto mark-read for active tab if there are unread messages
    if (activeChat === 'seller' && sellerUnread > 0) markRead('seller');
    if (activeChat === 'buyer' && buyerUnread > 0) markRead('buyer');
}

function renderMessages(containerId, messages) {
    const container = document.getElementById(containerId);
    const chatTarget = containerId === 'sellerMessages' ? 'seller' : 'buyer';

    if (messages.length === 0) {
        container.innerHTML = '<div class="empty">Нет сообщений</div>';
        return;
    }

    const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

    container.innerHTML = messages.map(msg => {
        const replyRefHtml = renderReplyRef(msg);
        const replyBtnHtml = dealClosed ? '' :
            `<div class="message-actions"><button class="btn-reply" onclick="setReply('${chatTarget}', ${msg.id}, '${escapeAttr(msg.sender_name)}', '${escapeAttr(truncate(msg.content, 60))}')">&#8617; Ответить</button></div>`;
        const readIndicator = msg.role === 'manager' ? '<span class="message-read-indicator">✓</span>' : '';
        return `
            <div class="message message-${msg.role}" data-msg-id="${msg.id}">
                ${replyRefHtml}
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(msg.sender_name)}</span>
                    <span class="message-time">${formatTime(msg.created_at)}${readIndicator}</span>
                </div>
                <div class="message-content">${renderMessageContent(msg)}</div>
                ${replyBtnHtml}
            </div>
        `;
    }).join('');

    if (wasScrolledToBottom) {
        container.scrollTop = container.scrollHeight;
    }
}

function renderReplyRef(msg) {
    if (!msg.reply_to_sender_name || !msg.reply_to_content) return '';
    const content = msg.reply_to_content.replace(/\[фото\]|\[видео\]|\[документ\]/, function(m) {
        return {'[фото]': 'Фото', '[видео]': 'Видео', '[документ]': 'Документ'}[m] || m;
    });
    // Determine role class from sender name
    let roleClass = '';
    const sn = msg.reply_to_sender_name;
    if (sn === 'Продавец') roleClass = 'reply-from-seller';
    else if (sn === 'Покупатель') roleClass = 'reply-from-buyer';
    else if (sn === 'Ассистент') roleClass = 'reply-from-ai';
    else roleClass = 'reply-from-manager';
    return `<div class="message-reply-ref ${roleClass}">
        <span class="reply-ref-sender">${escapeHtml(msg.reply_to_sender_name)}</span>
        <span class="reply-ref-text">${escapeHtml(content)}</span>
    </div>`;
}

let replyTo = { seller: null, buyer: null };

function setReply(target, msgId, senderName, text) {
    replyTo[target] = { id: msgId, sender: senderName, text: text };
    document.getElementById(`${target}ReplyPreview`).style.display = 'flex';
    document.getElementById(`${target}ReplySender`).textContent = senderName;
    document.getElementById(`${target}ReplyText`).textContent = text;
    document.getElementById(`${target}MessageInput`).focus();
}

function cancelReply(target) {
    replyTo[target] = null;
    document.getElementById(`${target}ReplyPreview`).style.display = 'none';
}

function escapeAttr(text) {
    return text.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
}

function truncate(text, len) {
    if (!text) return '';
    return text.length > len ? text.substring(0, len) + '...' : text;
}

let selectedFiles = { seller: null, buyer: null };

function handleFileSelect(target, input) {
    const file = input.files[0];
    if (!file) return;

    if (file.size > 50 * 1024 * 1024) {
        alert('Файл слишком большой (макс. 50 МБ)');
        input.value = '';
        return;
    }

    selectedFiles[target] = file;
    const preview = document.getElementById(`${target}FilePreview`);
    const nameEl = document.getElementById(`${target}FileName`);
    nameEl.textContent = `\uD83D\uDCCE ${file.name} (${formatFileSize(file.size)})`;
    preview.style.display = 'flex';
}

function clearFileSelection(target) {
    selectedFiles[target] = null;
    document.getElementById(`${target}FileInput`).value = '';
    document.getElementById(`${target}FilePreview`).style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' Б';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(0) + ' КБ';
    return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
}

async function sendFileMessage(target) {
    const file = selectedFiles[target];
    if (!file) return;

    const inputId = target === 'seller' ? 'sellerMessageInput' : 'buyerMessageInput';
    const input = document.getElementById(inputId);
    const caption = input.value.trim();

    // Find the send button
    const inputArea = document.getElementById(`${target}InputArea`);
    const btn = inputArea.querySelector('.btn-primary');
    btn.disabled = true;

    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('target', target);
        formData.append('caption', caption);
        if (replyTo[target]) {
            formData.append('reply_to_msg_id', replyTo[target].id);
        }

        const response = await fetch(`/panel/chat/${negotiationId}/send-file`, {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            clearFileSelection(target);
            cancelReply(target);
            input.value = '';
            loadMessages();
        } else {
            const data = await response.json();
            alert(data.detail || 'Ошибка отправки файла');
        }
    } catch (e) {
        alert('Ошибка сети при отправке файла');
    } finally {
        btn.disabled = false;
    }
}

async function sendMessage(target) {
    if (dealClosed) return;

    // If file is selected, send file instead
    if (selectedFiles[target]) {
        return sendFileMessage(target);
    }

    const inputId = target === 'seller' ? 'sellerMessageInput' : 'buyerMessageInput';
    const input = document.getElementById(inputId);
    const content = input.value.trim();
    if (!content) return;

    const inputArea = document.getElementById(`${target}InputArea`);
    const btn = inputArea.querySelector('.btn-primary');
    btn.disabled = true;

    try {
        const body = { content, target };
        if (replyTo[target]) {
            body.reply_to_msg_id = replyTo[target].id;
        }
        const response = await fetch(`/panel/chat/${negotiationId}/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (response.ok) {
            input.value = '';
            cancelReply(target);
            loadMessages();
        } else {
            const data = await response.json();
            alert(data.detail || 'Ошибка');
        }
    } finally {
        btn.disabled = false;
    }
}

async function closeDeal(status) {
    const resolution = prompt('Комментарий (опционально):');

    const response = await fetch(`/panel/chat/${negotiationId}/close`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, resolution })
    });

    if (response.ok) {
        loadMessages();
        alert('Сделка закрыта');
    } else {
        const data = await response.json();
        alert(data.detail || 'Ошибка');
    }
}

function toggleDealDetails() {
    const body = document.getElementById('dealDetailsBody');
    const toggle = document.getElementById('dealDetailsToggle');
    if (body.style.display === 'none') {
        body.style.display = 'block';
        toggle.innerHTML = '&#9650;';
    } else {
        body.style.display = 'none';
        toggle.innerHTML = '&#9660;';
    }
}

async function saveNotes() {
    const notes = document.getElementById('dealNotes').value;
    const res = await fetch(`/panel/chat/${negotiationId}/notes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
    });
    if (res.ok) {
        alert('Заметки сохранены');
    } else {
        alert('Ошибка сохранения');
    }
}

async function markRead(target) {
    try {
        await fetch(`/panel/chat/${negotiationId}/mark-read?target=${target}`, {
            method: 'POST'
        });
    } catch(e) {}
}

function switchChat(chat) {
    activeChat = chat;

    // Update tabs
    document.querySelectorAll('.chat-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.chat === chat);
    });

    // Update chat panels
    document.getElementById('sellerChat').classList.toggle('active', chat === 'seller');
    document.getElementById('buyerChat').classList.toggle('active', chat === 'buyer');

    // Mark messages in switched-to tab as read
    markRead(chat);
}

function getStatusLabel(status) {
    const labels = {
        'cold': 'Cold',
        'in_progress': 'В процессе',
        'warm': 'Warm',
        'handed_to_manager': 'В работе',
        'won': 'Выиграна',
        'lost': 'Проиграна'
    };
    return labels[status] || status;
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        maximumFractionDigits: 0
    }).format(value);
}

function formatTime(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();

    if (isToday) {
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' }) +
           ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function renderMessageContent(msg) {
    const mediaUrl = `/panel/chat/${negotiationId}/media/${msg.id}`;

    if (msg.media_type === 'photo') {
        const caption = (msg.content && msg.content !== '[фото]')
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        return caption + `<img src="${mediaUrl}" loading="lazy" class="media-photo" onclick="openFullscreen(this.src)" alt="Фото">`;
    }
    if (msg.media_type === 'video') {
        const caption = (msg.content && msg.content !== '[видео]')
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        return caption + `<video controls preload="none" class="media-video"><source src="${mediaUrl}" type="video/mp4"></video>`;
    }
    if (msg.media_type === 'document') {
        const isPlaceholder = !msg.content || msg.content === '[документ]' || msg.content.startsWith('[документ:');
        const caption = !isPlaceholder
            ? `<div style="margin-bottom:4px">${escapeHtml(msg.content)}</div>` : '';
        const docName = msg.file_name || 'Скачать документ';
        const ext = docName.includes('.') ? docName.split('.').pop().toLowerCase() : '';
        const icon = {'pdf': '\uD83D\uDCC4', 'doc': '\uD83D\uDCC3', 'docx': '\uD83D\uDCC3', 'xls': '\uD83D\uDCCA', 'xlsx': '\uD83D\uDCCA', 'zip': '\uD83D\uDCE6', 'rar': '\uD83D\uDCE6'}[ext] || '\uD83D\uDCCE';
        return caption + `<a href="${mediaUrl}" target="_blank" class="media-doc-link">${icon} ${escapeHtml(docName)}</a>`;
    }
    if (msg.media_type === 'sticker') {
        return `<img src="${mediaUrl}" loading="lazy" class="media-sticker" alt="Стикер">`;
    }
    return escapeHtml(msg.content);
}

function openFullscreen(src) {
    const overlay = document.getElementById('mediaOverlay');
    const img = document.getElementById('mediaOverlayImg');
    img.src = src;
    overlay.style.display = 'flex';
}

function closeFullscreen() {
    document.getElementById('mediaOverlay').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle Enter key for sending messages
document.getElementById('sellerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('seller');
});

document.getElementById('buyerMessageInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage('buyer');
});

// Listen for notifications from base.html polling
window.addEventListener('arbion:notifications', (e) => {
    const data = e.detail;
    const currentDeal = data.deals_with_unread.find(
        d => d.negotiation_id === negotiationId
    );
    if (currentDeal && (currentDeal.unread_seller > 0 || currentDeal.unread_buyer > 0)) {
        loadMessages();
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
{% endblock %}
