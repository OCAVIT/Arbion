{% extends "base.html" %}

{% block body %}
<div class="app-container">
    <!-- Mobile Header -->
    <header class="mobile-header">
        <h2>Arbion</h2>
        <button class="hamburger" onclick="toggleSidebar()" aria-label="–ú–µ–Ω—é">‚ò∞</button>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar sidebar-panel" id="sidebar">
        <div class="sidebar-header">
            <h2>Arbion</h2>
            <span class="badge badge-manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ</div>
            <a href="/panel" class="nav-item {% if request.url.path == '/panel' or request.url.path == '/panel/dashboard' %}active{% endif %}">
                <span class="nav-icon">üè†</span>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="/panel/deals" class="nav-item {% if '/deals' in request.url.path %}active{% endif %}">
                <span class="nav-icon">üíº</span>
                <span>–ú–æ–∏ —Å–¥–µ–ª–∫–∏</span>
            </a>
            <a href="/panel/announcements" class="nav-item {% if '/announcements' in request.url.path %}active{% endif %}" id="navAnnouncements">
                <span class="nav-icon">üì¢</span>
                <span>–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                <span class="nav-badge" id="announcementBadge" style="display:none;"></span>
            </a>

            <div class="nav-section">–ê–∫–∫–∞—É–Ω—Ç</div>
            <a href="/panel/profile" class="nav-item {% if '/profile' in request.url.path %}active{% endif %}">
                <span class="nav-icon">üë§</span>
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                üëã {{ user.display_name }}
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-left">
                <h1>{% block page_title %}–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞{% endblock %}</h1>
            </div>
            <div class="header-right">
                {% block header_actions %}{% endblock %}
                <button onclick="logout()" class="btn btn-sm btn-outline logout-btn" title="–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞">
                    üö™ –í—ã—Ö–æ–¥
                </button>
            </div>
        </header>

        <div class="content-body">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<script>
async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/login';
}

// Mobile sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
}

// Close sidebar when clicking on a nav link (mobile)
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            closeSidebar();
        }
    });
});

// Close sidebar on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeSidebar();
    }
});

// Announcement unread badge
let _lastUnreadCount = 0;
async function checkUnreadAnnouncements() {
    try {
        const resp = await fetch('/panel/announcements/unread-count');
        if (!resp.ok) return;
        const data = await resp.json();
        const badge = document.getElementById('announcementBadge');
        if (!badge) return;
        if (data.unread_count > 0) {
            badge.textContent = data.unread_count;
            badge.style.display = 'inline-flex';
            // Play sound & animate on NEW unread (count increased)
            if (data.unread_count > _lastUnreadCount && _lastUnreadCount >= 0) {
                badge.classList.remove('nav-badge-pulse');
                void badge.offsetWidth; // reflow
                badge.classList.add('nav-badge-pulse');
                if (_lastUnreadCount > 0 || document.visibilityState === 'visible') {
                    try {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = 880;
                        osc.type = 'sine';
                        gain.gain.value = 0.15;
                        osc.start();
                        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
                        osc.stop(ctx.currentTime + 0.3);
                    } catch(e) {}
                }
            }
            _lastUnreadCount = data.unread_count;
        } else {
            badge.style.display = 'none';
            badge.textContent = '';
            _lastUnreadCount = 0;
        }
    } catch(e) {}
}
// Initial check + poll every 30s
checkUnreadAnnouncements();
setInterval(checkUnreadAnnouncements, 30000);
</script>
{% endblock %}
