{% extends "base.html" %}

{% block body %}
<div class="app-container">
    <!-- Mobile Header -->
    <header class="mobile-header">
        <h2>Arbion</h2>
        <button class="hamburger" onclick="toggleSidebar()" aria-label="ĞœĞµĞ½Ñ">â˜°</button>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar sidebar-panel" id="sidebar">
        <div class="sidebar-header">
            <h2>Arbion</h2>
            <span class="badge badge-manager">ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">Ğ Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ¼ĞµÑÑ‚Ğ¾</div>
            <a href="/panel" class="nav-item {% if request.url.path == '/panel' or request.url.path == '/panel/dashboard' %}active{% endif %}" id="navDashboard">
                <span class="nav-icon">ğŸ </span>
                <span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span>
                <span class="nav-badge nav-badge-leads" id="leadsBadge" style="display:none;"></span>
            </a>
            <a href="/panel/deals" class="nav-item {% if '/deals' in request.url.path %}active{% endif %}" id="navDeals">
                <span class="nav-icon">ğŸ’¼</span>
                <span>ĞœĞ¾Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸</span>
                <span class="nav-badge nav-badge-messages" id="dealsBadge" style="display:none;"></span>
            </a>
            <a href="/panel/announcements" class="nav-item {% if '/announcements' in request.url.path %}active{% endif %}" id="navAnnouncements">
                <span class="nav-icon">ğŸ“¢</span>
                <span>Ğ’Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</span>
                <span class="nav-badge" id="announcementBadge" style="display:none;"></span>
            </a>

            <div class="nav-section">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</div>
            <a href="/panel/profile" class="nav-item {% if '/profile' in request.url.path %}active{% endif %}">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                ğŸ‘‹ {{ user.display_name }}
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-left">
                <h1>{% block page_title %}ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°{% endblock %}</h1>
            </div>
            <div class="header-right">
                {% block header_actions %}{% endblock %}
                <button onclick="logout()" class="btn btn-sm btn-outline logout-btn" title="Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°">
                    ğŸšª Ğ’Ñ‹Ñ…Ğ¾Ğ´
                </button>
            </div>
        </header>

        <div class="content-body">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Toast Notification Styles -->
<style>
.toast-container {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-width: 380px;
    pointer-events: none;
}
.toast {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 12px;
    background: var(--bg-card, #1e293b);
    border: 1px solid var(--border-color, #334155);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    pointer-events: all;
}
.toast-visible {
    opacity: 1;
    transform: translateX(0);
}
.toast-icon {
    font-size: 22px;
    flex-shrink: 0;
    line-height: 1.2;
}
.toast-content {
    flex: 1;
    min-width: 0;
}
.toast-title {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-primary, #f1f5f9);
    margin-bottom: 2px;
}
.toast-body {
    font-size: 13px;
    color: var(--text-secondary, #94a3b8);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
.toast-close {
    background: none;
    border: none;
    color: var(--text-muted, #64748b);
    font-size: 18px;
    cursor: pointer;
    padding: 0 4px;
    line-height: 1;
    flex-shrink: 0;
}
.toast-close:hover {
    color: var(--text-primary, #f1f5f9);
}
.toast-lead { border-left: 4px solid #f97316; }
.toast-message { border-left: 4px solid #3b82f6; }
.toast-announcement { border-left: 4px solid #eab308; }
.toast-success { border-left: 4px solid #22c55e; }
.toast-error { border-left: 4px solid #ef4444; }
.toast-info { border-left: 4px solid #6366f1; }
@media (max-width: 480px) {
    .toast-container {
        left: 8px;
        right: 8px;
        max-width: none;
        top: 8px;
    }
}
</style>

<script>
async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/login';
}

// Mobile sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
}

// Close sidebar when clicking on a nav link (mobile)
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            closeSidebar();
        }
    });
});

// Close sidebar on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeSidebar();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED NOTIFICATION SYSTEM v2
// Rich toasts + 4 distinct sounds + browser notifications
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Toast System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _toastContainer = null;
function _getToastContainer() {
    if (!_toastContainer) {
        _toastContainer = document.createElement('div');
        _toastContainer.className = 'toast-container';
        document.body.appendChild(_toastContainer);
    }
    return _toastContainer;
}

/**
 * Show a rich toast notification.
 * @param {Object} opts
 * @param {string} opts.title - Bold title line
 * @param {string} [opts.body] - Secondary description
 * @param {string} [opts.type] - 'lead'|'message'|'announcement'|'success'|'error'|'info'
 * @param {string} [opts.href] - Navigate on click
 * @param {number} [opts.duration=6000] - Auto-dismiss ms
 */
function showToast(opts) {
    const container = _getToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast toast-${opts.type || 'info'}`;
    const icons = {
        lead: '\uD83D\uDD25', message: '\uD83D\uDCAC', announcement: '\uD83D\uDCE2',
        success: '\u2705', error: '\u274C', info: '\u2139\uFE0F'
    };
    toast.innerHTML = `
        <div class="toast-icon">${icons[opts.type] || '\u2139\uFE0F'}</div>
        <div class="toast-content">
            <div class="toast-title">${opts.title}</div>
            ${opts.body ? `<div class="toast-body">${opts.body}</div>` : ''}
        </div>
        <button class="toast-close" onclick="event.stopPropagation();this.parentElement.remove()">&times;</button>
    `;
    if (opts.href) {
        toast.style.cursor = 'pointer';
        toast.addEventListener('click', (e) => {
            if (!e.target.classList.contains('toast-close')) window.location.href = opts.href;
        });
    }
    container.prepend(toast);
    requestAnimationFrame(() => { requestAnimationFrame(() => toast.classList.add('toast-visible')); });
    const dur = opts.duration || 6000;
    setTimeout(() => {
        toast.classList.remove('toast-visible');
        setTimeout(() => toast.remove(), 300);
    }, dur);
}

// Backwards-compat wrapper for child pages
function showNotification(message, type = 'info') {
    showToast({ title: message, type: type });
}

// â”€â”€ Shared AudioContext â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _audioCtx = null;
function _getAudioCtx() {
    if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return _audioCtx;
}

// SOUND 1: Announcement â€” 880Hz sine, 300ms (official, formal)
async function playAnnouncementSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.frequency.value = 880; osc.type = 'sine';
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } catch(e) {}
}

// SOUND 2: New Message â€” two-tone C5+E5 sine (gentle, pleasant)
async function playMessageSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        [523, 659].forEach((f, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value = f; osc.type = 'sine';
            const t = now + i * 0.17;
            gain.gain.setValueAtTime(0.12, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
            osc.start(t); osc.stop(t + 0.15);
        });
    } catch(e) {}
}

// SOUND 3: New Lead / Cold Deal â€” 3-note ascending Eb5+G5+Bb5 sawtooth (urgent, bright)
async function playLeadSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        [622, 784, 932].forEach((f, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value = f; osc.type = 'sawtooth';
            const t = now + i * 0.12;
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.10, t + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.18);
            osc.start(t); osc.stop(t + 0.18);
        });
    } catch(e) {}
}

// SOUND 4: Browser/Off-screen Alert â€” pulsing square wave A4â†’A5â†’A4 (distinct urgency)
async function playBrowserAlertSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.linearRampToValueAtTime(880, now + 0.15);
        osc.frequency.linearRampToValueAtTime(440, now + 0.3);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.35);
        osc.start(now); osc.stop(now + 0.35);
    } catch(e) {}
}

// â”€â”€ Browser Notifications API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _notifPermission = ('Notification' in window) ? Notification.permission : 'denied';

function _requestNotifPermission() {
    if (!('Notification' in window)) return;
    if (_notifPermission === 'default') {
        Notification.requestPermission().then(p => { _notifPermission = p; });
    }
}

function _showBrowserNotif(title, body, href, tag) {
    if (_notifPermission !== 'granted' || document.hasFocus()) return;
    try {
        const n = new Notification(title, {
            body: body,
            tag: tag || ('arbion-' + Date.now()),
            requireInteraction: false,
        });
        if (href) {
            n.onclick = () => { window.focus(); window.location.href = href; n.close(); };
        }
        setTimeout(() => n.close(), 10000);
    } catch(e) {}
}

// Request notification permission on first user interaction
document.addEventListener('click', function _reqPerm() {
    _requestNotifPermission();
    document.removeEventListener('click', _reqPerm);
}, { once: true });

// â”€â”€ Badge helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _updateBadge(el, count, playPulse) {
    if (!el) return;
    if (count > 0) {
        el.textContent = count;
        el.style.display = 'inline-flex';
        if (playPulse) {
            el.classList.remove('nav-badge-pulse');
            void el.offsetWidth;
            el.classList.add('nav-badge-pulse');
        }
    } else {
        el.style.display = 'none';
        el.textContent = '';
    }
}

// â”€â”€ Announcement polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _lastAnnouncementCount = -1;
async function checkUnreadAnnouncements() {
    try {
        const resp = await fetch('/panel/announcements/unread-count');
        if (!resp.ok) return;
        const data = await resp.json();
        const badge = document.getElementById('announcementBadge');
        const grew = _lastAnnouncementCount >= 0 && data.unread_count > _lastAnnouncementCount;
        _updateBadge(badge, data.unread_count, grew);
        if (grew) {
            playAnnouncementSound();
            showToast({
                title: 'ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ',
                body: 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ» "Ğ’Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ"',
                type: 'announcement',
                href: '/panel/announcements',
                duration: 8000,
            });
            if (!document.hasFocus()) {
                _showBrowserNotif('ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±ÑŠÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ', 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ "Ğ’Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ"', '/panel/announcements', 'arbion-ann');
                playBrowserAlertSound();
            }
        }
        _lastAnnouncementCount = data.unread_count > 0 ? data.unread_count : 0;
    } catch(e) {}
}

// â”€â”€ Unified notification polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _lastTotalUnread = -1;
let _lastNewLeads = -1;
let _lastColdDeals = -1;

async function checkNotifications() {
    try {
        const resp = await fetch('/panel/notifications/status');
        if (!resp.ok) return;
        const data = await resp.json();

        // Badge: unread messages on "ĞœĞ¾Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸"
        const dealsBadge = document.getElementById('dealsBadge');
        const msgGrew = _lastTotalUnread >= 0 && data.total_unread_messages > _lastTotalUnread;
        _updateBadge(dealsBadge, data.total_unread_messages, msgGrew);

        // Badge: leads on "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ" (pool + my cold deals)
        const leadsBadge = document.getElementById('leadsBadge');
        const totalLeads = data.new_leads_count + (data.my_cold_deals_count || 0);
        const leadsGrew = _lastNewLeads >= 0 && data.new_leads_count > _lastNewLeads;
        const coldGrew = _lastColdDeals >= 0 && (data.my_cold_deals_count || 0) > _lastColdDeals;
        _updateBadge(leadsBadge, totalLeads, leadsGrew || coldGrew);

        // â”€â”€ New Message â†’ rich toast + sound + browser notif â”€â”€
        if (msgGrew) {
            const dealsWithNew = data.deals_with_unread;
            for (const deal of dealsWithNew.slice(0, 3)) {
                const sender = deal.last_sender_role === 'buyer' ? 'ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ' : 'ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†';
                showToast({
                    title: `${sender} \u2022 ${deal.product}`,
                    body: deal.last_message_preview || 'ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ',
                    type: 'message',
                    href: `/panel/chat/${deal.negotiation_id}`,
                    duration: 8000,
                });
            }
            playMessageSound();
            if (!document.hasFocus()) {
                const top = dealsWithNew[0];
                if (top) {
                    const s = top.last_sender_role === 'buyer' ? 'ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ' : 'ĞŸÑ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†';
                    _showBrowserNotif(
                        `${s} Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»`,
                        top.last_message_preview || `Ğ¡Ğ´ĞµĞ»ĞºĞ°: ${top.product}`,
                        `/panel/chat/${top.negotiation_id}`,
                        'arbion-msg'
                    );
                    playBrowserAlertSound();
                }
            }
        }
        _lastTotalUnread = data.total_unread_messages;

        // â”€â”€ New Lead (Pool) â†’ rich toast + sound + browser notif â”€â”€
        if (leadsGrew) {
            const cnt = data.new_leads_count - _lastNewLeads;
            showToast({
                title: 'ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ğ´ Ğ² Ğ¿ÑƒĞ»Ğµ',
                body: `${cnt} ${cnt === 1 ? 'Ğ½Ğ¾Ğ²Ğ°Ñ ÑĞ´ĞµĞ»ĞºĞ°' : 'Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº'} Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°`,
                type: 'lead',
                href: '/panel',
                duration: 10000,
            });
            playLeadSound();
            if (!document.hasFocus()) {
                _showBrowserNotif('ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ğ´!', `${cnt} Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº Ğ² Ğ¿ÑƒĞ»Ğµ`, '/panel', 'arbion-lead');
                playBrowserAlertSound();
            }
        }
        _lastNewLeads = data.new_leads_count;

        // â”€â”€ Cold Deal Assigned to Me â†’ rich toast + sound + browser notif â”€â”€
        if (coldGrew) {
            const cnt = (data.my_cold_deals_count || 0) - _lastColdDeals;
            showToast({
                title: 'ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ°Ñ ÑĞ´ĞµĞ»ĞºĞ°!',
                body: `${cnt} ${cnt === 1 ? 'Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ğ´' : 'Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ»Ğ¸Ğ´Ğ¾Ğ²'} Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¾ Ğ²Ğ°Ğ¼`,
                type: 'lead',
                href: '/panel/deals',
                duration: 10000,
            });
            playLeadSound();
            if (!document.hasFocus()) {
                _showBrowserNotif('ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° ÑĞ´ĞµĞ»ĞºĞ°!', `Ğ£ Ğ²Ğ°Ñ ${cnt} Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ñ‹Ñ… ÑĞ´ĞµĞ»Ğ¾Ğº`, '/panel/deals', 'arbion-cold');
                playBrowserAlertSound();
            }
        }
        _lastColdDeals = data.my_cold_deals_count || 0;

        // Dispatch event for child pages (chat.html, deals.html)
        window.dispatchEvent(new CustomEvent('arbion:notifications', {
            detail: data
        }));
    } catch(e) {}
}

// Initial checks + polling (7s for notifications, 15s for announcements)
checkUnreadAnnouncements();
setInterval(checkUnreadAnnouncements, 15000);
checkNotifications();
setInterval(checkNotifications, 7000);
</script>
{% endblock %}
