{% extends "base.html" %}

{% block body %}
<div class="app-container">
    <!-- Mobile Header -->
    <header class="mobile-header">
        <h2>Arbion</h2>
        <button class="hamburger" onclick="toggleSidebar()" aria-label="ĞœĞµĞ½Ñ">â˜°</button>
    </header>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar sidebar-panel" id="sidebar">
        <div class="sidebar-header">
            <h2>Arbion</h2>
            <span class="badge badge-manager">ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">Ğ Ğ°Ğ±Ğ¾Ñ‡ĞµĞµ Ğ¼ĞµÑÑ‚Ğ¾</div>
            <a href="/panel" class="nav-item {% if request.url.path == '/panel' or request.url.path == '/panel/dashboard' %}active{% endif %}" id="navDashboard">
                <span class="nav-icon">ğŸ </span>
                <span>Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ</span>
                <span class="nav-badge nav-badge-leads" id="leadsBadge" style="display:none;"></span>
            </a>
            <a href="/panel/deals" class="nav-item {% if '/deals' in request.url.path %}active{% endif %}" id="navDeals">
                <span class="nav-icon">ğŸ’¼</span>
                <span>ĞœĞ¾Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸</span>
                <span class="nav-badge nav-badge-messages" id="dealsBadge" style="display:none;"></span>
            </a>
            <a href="/panel/announcements" class="nav-item {% if '/announcements' in request.url.path %}active{% endif %}" id="navAnnouncements">
                <span class="nav-icon">ğŸ“¢</span>
                <span>Ğ’Ğ°Ğ¶Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</span>
                <span class="nav-badge" id="announcementBadge" style="display:none;"></span>
            </a>

            <div class="nav-section">ĞĞºĞºĞ°ÑƒĞ½Ñ‚</div>
            <a href="/panel/profile" class="nav-item {% if '/profile' in request.url.path %}active{% endif %}">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                ğŸ‘‹ {{ user.display_name }}
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-left">
                <h1>{% block page_title %}ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ°{% endblock %}</h1>
            </div>
            <div class="header-right">
                {% block header_actions %}{% endblock %}
                <button onclick="logout()" class="btn btn-sm btn-outline logout-btn" title="Ğ’Ñ‹Ğ¹Ñ‚Ğ¸ Ğ¸Ğ· Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°">
                    ğŸšª Ğ’Ñ‹Ñ…Ğ¾Ğ´
                </button>
            </div>
        </header>

        <div class="content-body">
            {% block content %}{% endblock %}
        </div>
    </main>
</div>

<script>
async function logout() {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/login';
}

// Mobile sidebar toggle
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.mobile-overlay');
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
}

// Close sidebar when clicking on a nav link (mobile)
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            closeSidebar();
        }
    });
});

// Close sidebar on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeSidebar();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED NOTIFICATION SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Toast notification (shared across all panel pages)
function showNotification(message, type = 'info') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="notification-close">&times;</button>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

// â”€â”€ Shared AudioContext â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _audioCtx = null;
function _getAudioCtx() {
    if (!_audioCtx) {
        _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return _audioCtx;
}

// Announcement sound: 880Hz sine, 300ms
async function playAnnouncementSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    } catch(e) {}
}

// Message sound: two-tone C5+E5 (523Hz, 659Hz)
async function playMessageSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1); gain1.connect(ctx.destination);
        osc1.frequency.value = 523; osc1.type = 'sine';
        gain1.gain.setValueAtTime(0.12, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        osc1.start(now); osc1.stop(now + 0.15);

        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2); gain2.connect(ctx.destination);
        osc2.frequency.value = 659; osc2.type = 'sine';
        gain2.gain.setValueAtTime(0.12, now + 0.17);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.32);
        osc2.start(now + 0.17); osc2.stop(now + 0.32);
    } catch(e) {}
}

// Lead sound: ascending D5+G5 (587Hz, 784Hz), triangle wave
async function playLeadSound() {
    try {
        const ctx = _getAudioCtx();
        if (ctx.state === 'suspended') await ctx.resume();
        const now = ctx.currentTime;
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1); gain1.connect(ctx.destination);
        osc1.frequency.value = 587; osc1.type = 'triangle';
        gain1.gain.setValueAtTime(0.15, now);
        gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
        osc1.start(now); osc1.stop(now + 0.2);

        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.connect(gain2); gain2.connect(ctx.destination);
        osc2.frequency.value = 784; osc2.type = 'triangle';
        gain2.gain.setValueAtTime(0.15, now + 0.22);
        gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.45);
        osc2.start(now + 0.22); osc2.stop(now + 0.45);
    } catch(e) {}
}

// â”€â”€ Badge helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _updateBadge(el, count, playPulse) {
    if (!el) return;
    if (count > 0) {
        el.textContent = count;
        el.style.display = 'inline-flex';
        if (playPulse) {
            el.classList.remove('nav-badge-pulse');
            void el.offsetWidth;
            el.classList.add('nav-badge-pulse');
        }
    } else {
        el.style.display = 'none';
        el.textContent = '';
    }
}

// â”€â”€ Announcement polling (existing, refactored) â”€â”€â”€â”€

let _lastAnnouncementCount = -1;
async function checkUnreadAnnouncements() {
    try {
        const resp = await fetch('/panel/announcements/unread-count');
        if (!resp.ok) return;
        const data = await resp.json();
        const badge = document.getElementById('announcementBadge');
        const grew = _lastAnnouncementCount >= 0 && data.unread_count > _lastAnnouncementCount;
        _updateBadge(badge, data.unread_count, grew);
        if (grew) playAnnouncementSound();
        _lastAnnouncementCount = data.unread_count > 0 ? data.unread_count : 0;
    } catch(e) {}
}

// â”€â”€ Unified notification polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _lastTotalUnread = -1;
let _lastNewLeads = -1;

async function checkNotifications() {
    try {
        const resp = await fetch('/panel/notifications/status');
        if (!resp.ok) return;
        const data = await resp.json();

        // Message badge on "ĞœĞ¾Ğ¸ ÑĞ´ĞµĞ»ĞºĞ¸"
        const dealsBadge = document.getElementById('dealsBadge');
        const msgGrew = _lastTotalUnread >= 0 && data.total_unread_messages > _lastTotalUnread;
        _updateBadge(dealsBadge, data.total_unread_messages, msgGrew);

        // Leads badge on "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ"
        const leadsBadge = document.getElementById('leadsBadge');
        const leadsGrew = _lastNewLeads >= 0 && data.new_leads_count > _lastNewLeads;
        _updateBadge(leadsBadge, data.new_leads_count, leadsGrew);

        // Tier 1: New message â†’ toast + sound
        if (msgGrew) {
            const newest = data.deals_with_unread[0];
            if (newest) {
                const cnt = data.total_unread_messages - _lastTotalUnread;
                showNotification(
                    `ĞĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (${cnt}) Ğ¿Ğ¾ ÑĞ´ĞµĞ»ĞºĞµ "${newest.product}"`,
                    'info'
                );
                playMessageSound();
            }
        }
        _lastTotalUnread = data.total_unread_messages;

        // Tier 1: New lead â†’ toast + sound
        if (leadsGrew) {
            const cnt = data.new_leads_count - _lastNewLeads;
            showNotification(
                `ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ»Ğ¸Ğ´ Ğ² Ğ¿ÑƒĞ»Ğµ (${cnt})`,
                'success'
            );
            playLeadSound();
        }
        _lastNewLeads = data.new_leads_count;

        // Dispatch event for child pages (chat.html)
        window.dispatchEvent(new CustomEvent('arbion:notifications', {
            detail: data
        }));
    } catch(e) {}
}

// Initial checks + polling
checkUnreadAnnouncements();
setInterval(checkUnreadAnnouncements, 15000);
checkNotifications();
setInterval(checkNotifications, 10000);
</script>
{% endblock %}
