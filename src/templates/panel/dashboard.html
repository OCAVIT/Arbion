{% extends "panel/base.html" %}

{% block page_title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="metrics-grid">
    <div class="metric-card" title="–°–¥–µ–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–µ–π—á–∞—Å –≤ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ">
        <div class="metric-title">–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</div>
        <div class="metric-value" id="activeDeals">-</div>
    </div>
    <div class="metric-card" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü">
        <div class="metric-title">–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="metric-value" id="closedMonth">-</div>
    </div>
    <div class="metric-card" title="–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –∑–∞–∫—Ä—ã—Ç—ã—Ö">
        <div class="metric-title">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        <div class="metric-value" id="conversionRate">-</div>
    </div>
    <div class="metric-card" title="–°—É–º–º–∞ –≤–∞—à–µ–π –∫–æ–º–∏—Å—Å–∏–∏ –ø–æ –∑–∞–∫—Ä—ã—Ç—ã–º —Å–¥–µ–ª–∫–∞–º">
        <div class="metric-title">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        <div class="metric-value text-success" id="totalEarned">-</div>
    </div>
    <div class="metric-card metric-card-accent" title="–¢—ë–ø–ª—ã–µ –ª–∏–¥—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –≤–∑—è—Ç–∏—è –≤ —Ä–∞–±–æ—Ç—É">
        <div class="metric-title">–î–æ—Å—Ç—É–ø–Ω–æ –≤ –ø—É–ª–µ</div>
        <div class="metric-value" id="warmPool">-</div>
    </div>
</div>

<!-- Help tooltips -->
<div class="help-bar">
    <span class="help-item" title="–¢—ë–ø–ª–∞—è —Å–¥–µ–ª–∫–∞ ‚Äî AI –ø—Ä–æ–≤—ë–ª –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã, –ø—Ä–æ–¥–∞–≤–µ—Ü –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω. –ì–æ—Ç–æ–≤–æ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.">üî• –¢—ë–ø–ª–∞—è —Å–¥–µ–ª–∫–∞</span>
    <span class="help-item" title="–ö–æ–Ω–≤–µ—Ä—Å–∏—è ‚Äî % –≤—ã–∏–≥—Ä–∞–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –∑–∞–∫—Ä—ã—Ç—ã—Ö. –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –ª—É—á—à–µ!">üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è</span>
    <span class="help-item" title="–ù–∞–∂–º–∏—Ç–µ '–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ —Å–¥–µ–ª–∫–æ–π">‚úÖ –ö–∞–∫ –≤–∑—è—Ç—å —Å–¥–µ–ª–∫—É</span>
</div>

<!-- Leads Pool -->
<div class="card" id="poolSection">
    <div class="card-header">
        <h3>–õ–∏–¥—ã –≤ –ø—É–ª–µ</h3>
    </div>
    <div class="card-body">
        <p class="card-description">–ù–æ–≤—ã–µ –ª–∏–¥—ã –æ—Ç AI –∏ —Ç—ë–ø–ª—ã–µ —Å–¥–µ–ª–∫–∏, –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞–±–æ—Ç–µ</p>
        <div class="deals-grid" id="poolDeals">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<!-- My Active Deals -->
<div class="card">
    <div class="card-header">
        <h3>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏</h3>
    </div>
    <div class="card-body">
        <div class="deals-grid" id="myDeals">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadPool();
    loadMyDeals();
});

async function loadStats() {
    try {
        const response = await fetch('/panel/dashboard/stats');
        if (!response.ok) throw new Error('Failed to load stats');
        const data = await response.json();

        document.getElementById('activeDeals').textContent = data.active_deals;
        document.getElementById('closedMonth').textContent = data.closed_this_month;
        document.getElementById('conversionRate').textContent = data.conversion_rate + '%';
        document.getElementById('warmPool').textContent = data.warm_leads_in_pool;
        if (data.total_earned !== undefined) {
            document.getElementById('totalEarned').textContent = formatMoney(data.total_earned);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadPool() {
    const response = await fetch('/panel/dashboard/pool');
    const data = await response.json();

    const container = document.getElementById('poolDeals');

    if (data.items.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ª–∏–¥–æ–≤</div>';
        return;
    }

    container.innerHTML = data.items.map(deal => `
        <div class="deal-card ${deal.status === 'cold' ? '' : 'deal-card-warm'}">
            <div class="deal-header">
                <span class="deal-product">${escapeHtml(deal.product)}</span>
                <span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span>
            </div>
            <div class="deal-price">${formatMoney(deal.sell_price)}</div>
            <div class="deal-region">${deal.region || '–†–µ–≥–∏–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
            ${deal.ai_draft_message ? '<div class="deal-meta" style="color:var(--text-secondary)">AI-–¥—Ä–∞—Ñ—Ç –≥–æ—Ç–æ–≤</div>' : ''}
            <div class="deal-actions">
                ${deal.status === 'cold' ?
                    `<a href="/panel/leads/${deal.id}" class="btn btn-primary btn-sm">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</a>` :
                    deal.can_take ?
                        `<button onclick="takeDeal(${deal.id})" class="btn btn-success btn-sm">–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>` :
                        `<button class="btn btn-sm" disabled title="${deal.take_blocked_reason}">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</button>`
                }
            </div>
        </div>
    `).join('');
}

async function loadMyDeals() {
    const response = await fetch('/panel/deals/list?include_pool=false');
    const data = await response.json();

    const container = document.getElementById('myDeals');

    if (data.items.length === 0) {
        container.innerHTML = '<div class="empty">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>';
        return;
    }

    container.innerHTML = data.items.map(deal => `
        <div class="deal-card">
            <div class="deal-header">
                <span class="deal-product">${escapeHtml(deal.product)}</span>
                <span class="badge badge-${deal.status}">${getStatusLabel(deal.status)}</span>
            </div>
            <div class="deal-price">${formatMoney(deal.sell_price)}</div>
            <div class="deal-region">${deal.region || '–†–µ–≥–∏–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
            <div class="deal-actions">
                ${deal.negotiation_id ?
                    `<a href="/panel/chat/${deal.negotiation_id}" class="btn btn-primary btn-sm">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>` :
                    '<span class="text-muted">–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏</span>'
                }
            </div>
        </div>
    `).join('');
}

async function takeDeal(dealId) {
    try {
        const response = await fetch(`/panel/deals/${dealId}/take`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            showNotification('–°–¥–µ–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É! –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º.', 'success');
            loadStats();
            loadPool();
            loadMyDeals();
        } else {
            const errorMessages = {
                'deal_not_found': '–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –µ—ë —É–∂–µ –≤–∑—è–ª –¥—Ä—É–≥–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä.',
                'deal_already_taken': '–≠—Ç–∞ —Å–¥–µ–ª–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.',
                'max_deals_reached': '–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫. –ó–∞–∫—Ä–æ–π—Ç–µ —Ç–µ–∫—É—â–∏–µ —Å–¥–µ–ª–∫–∏, —á—Ç–æ–±—ã –≤–∑—è—Ç—å –Ω–æ–≤—ã–µ.',
                'deal_not_warm': '–≠—Ç–∞ —Å–¥–µ–ª–∫–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—É.'
            };
            showNotification(errorMessages[data.detail] || data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å —Å–¥–µ–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.', 'error');
    }
}

function getStatusLabel(status) {
    const labels = {
        'cold': '–•–æ–ª–æ–¥–Ω–∞—è',
        'in_progress': '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        'warm': '–¢—ë–ø–ª–∞—è',
        'handed_to_manager': '–í —Ä–∞–±–æ—Ç–µ',
        'won': '–í—ã–∏–≥—Ä–∞–Ω–∞',
        'lost': '–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞'
    };
    return labels[status] || status;
}

function formatMoney(value) {
    return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Notification system
function showNotification(message, type = 'info') {
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="notification-close">&times;</button>
    `;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}
</script>
{% endblock %}
