# Arbion ‚Äî –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

> –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –≤ –∫–æ–¥–æ–≤—É—é –±–∞–∑—É Arbion.
> –ß–∏—Ç–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –í—ã–ø–æ–ª–Ω—è–π —Å–µ–∫—Ü–∏—é –∑–∞ —Å–µ–∫—Ü–∏–µ–π. –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–µ–∫—Ü–∏–∏ ‚Äî commit.
> –ù–ï –ª–æ–º–∞–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –∞–¥–¥–∏—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—è—é—â–∏–µ.

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ó–∞—á–µ–º —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

Arbion –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∏–∑ —Ä–µ–∂–∏–º–∞ "–ø—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏" –≤ —Ä–µ–∂–∏–º **–±–æ–µ–≤–æ–π B2B-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –æ–ø—Ç–æ–≤–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏**. –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã (–∞—Ä–º–∞—Ç—É—Ä–∞, —Ü–µ–º–µ–Ω—Ç, –ø—Ä–æ—Ñ–ª–∏—Å—Ç...)
2. AI –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –ø–∏—Å–∞—Ç—å –≤ Telegram ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–¥—Ä–∞—Ñ—Ç—ã** –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
3. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è LeadSource (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º—É–ª—å—Ç–∏-–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä)
4. –ö–æ–º–∏—Å—Å–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–∏–µ—Ä–Ω–æ–π (20% —Å–∏—Å—Ç–µ–º–Ω—ã–π –ª–∏–¥ / 35% —Å–≤–æ–π –ª–∏–¥)
5. –î–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –º–æ–¥–µ–ª–∏ (–∞–≥–µ–Ω—Ç—Å–∫–∞—è/—Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è —Å—Ö–µ–º–∞, —Å—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç)
6. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–∏—à–∞ (niche) –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–¥–µ–ª–æ–∫ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º

---

## –°–ï–ö–¶–ò–Ø 1: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î ‚Äî –ù–æ–≤—ã–µ –ø–æ–ª—è

–°–æ–∑–¥–∞–π Alembic-–º–∏–≥—Ä–∞—Ü–∏—é `011_strategic_update.py` —Å —ç—Ç–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:

### –¢–∞–±–ª–∏—Ü–∞ `orders` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º—É–ª—å—Ç–∏-–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
op.add_column('orders', sa.Column('platform', sa.String(20), server_default='telegram', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'telegram', 'whatsapp', 'max', 'avito', 'web', 'manual'

# –ù–∏—à–∞ —Ç–æ–≤–∞—Ä–∞ (AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ)
op.add_column('orders', sa.Column('niche', sa.String(50), nullable=True))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'construction', 'agriculture', 'fmcg', 'other'

# –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –æ–ø—Ç–∞: —Ç–æ–Ω–Ω—ã, –º¬≥, —à—Ç, –≤–∞–≥–æ–Ω)
op.add_column('orders', sa.Column('unit', sa.String(30), nullable=True))

# –û–±—ä—ë–º —á–∏—Å–ª–æ–º (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ä–∂–∏ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É)
op.add_column('orders', sa.Column('volume_numeric', sa.Numeric(12, 2), nullable=True))
```

### –¢–∞–±–ª–∏—Ü–∞ `detected_deals` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞: system (AI –Ω–∞—à—ë–ª) –∏–ª–∏ manager (–º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏–≤—ë–ª —Å–∞–º)
op.add_column('detected_deals', sa.Column('lead_source', sa.String(20), server_default='system', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'system', 'manager'

# –ù–∏—à–∞ —Å–¥–µ–ª–∫–∏
op.add_column('detected_deals', sa.Column('niche', sa.String(50), nullable=True))

# –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å–¥–µ–ª–∫–∏
op.add_column('detected_deals', sa.Column('deal_model', sa.String(20), server_default='agency', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'agency' (–∞–≥–µ–Ω—Ç—Å–∫–∞—è ‚Äî –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –ø—Ä–æ–¥–∞–≤—Ü—É –Ω–∞–ø—Ä—è–º—É—é), 'transit' (—Ç—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è ‚Äî —á–µ—Ä–µ–∑ –Ω–∞—à —Å—á—ë—Ç)

# –°—Ç–∞–≤–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –≠–¢–û–ô —Å–¥–µ–ª–∫–∏ (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏)
op.add_column('detected_deals', sa.Column('manager_commission_rate', sa.Numeric(5, 4), nullable=True))

# –°—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç
op.add_column('detected_deals', sa.Column('buyer_payment_status', sa.String(20), server_default='pending', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'pending', 'invoiced', 'paid', 'confirmed'

op.add_column('detected_deals', sa.Column('seller_payment_status', sa.String(20), server_default='pending', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'pending', 'paid'

op.add_column('detected_deals', sa.Column('our_commission_status', sa.String(20), server_default='pending', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'pending', 'invoiced', 'received'

op.add_column('detected_deals', sa.Column('payment_method', sa.String(20), nullable=True))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'bank_transfer', 'card', 'cash', 'crypto'

# –î—Ä–∞—Ñ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç, –º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç)
op.add_column('detected_deals', sa.Column('ai_draft_message', sa.Text(), nullable=True))

# –†—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ü–µ–Ω—ã (AI –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∏–∑ parsed messages)
op.add_column('detected_deals', sa.Column('market_price_context', sa.Text(), nullable=True))
# JSON: {"avg_price": 48500, "min_seen": 45000, "max_seen": 52000, "sources_count": 12, "last_updated": "..."}

# –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞-–∏—Å—Ç–æ—á–Ω–∏–∫
op.add_column('detected_deals', sa.Column('platform', sa.String(20), server_default='telegram', nullable=False))
```

### –¢–∞–±–ª–∏—Ü–∞ `users` (–º–µ–Ω–µ–¥–∂–µ—Ä—ã) ‚Äî –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –ù–∏—à–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (JSON array)
op.add_column('users', sa.Column('niches', sa.Text(), nullable=True))
# JSON: ["construction", "agriculture"]

# –£—Ä–æ–≤–µ–Ω—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
op.add_column('users', sa.Column('level', sa.String(20), server_default='junior', nullable=False))
# –ó–Ω–∞—á–µ–Ω–∏—è: 'junior', 'senior'

# Telegram user ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∞–∫–∫–∞—É–Ω—Ç—É, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω –ø–∏—à–µ—Ç)
op.add_column('users', sa.Column('telegram_user_id', sa.BigInteger(), nullable=True))
```

### –¢–∞–±–ª–∏—Ü–∞ `ledger` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –ú–æ–¥–µ–ª—å —Å–¥–µ–ª–∫–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è
op.add_column('ledger', sa.Column('deal_model', sa.String(20), nullable=True))

# –°—Ç–∞–≤–∫–∞ –∫–æ–º–∏—Å—Å–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è
op.add_column('ledger', sa.Column('commission_rate_applied', sa.Numeric(5, 4), nullable=True))

# –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è
op.add_column('ledger', sa.Column('lead_source', sa.String(20), nullable=True))
```

### –¢–∞–±–ª–∏—Ü–∞ `monitored_chats` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å:

```python
# –ù–∏—à–∞ —á–∞—Ç–∞
op.add_column('monitored_chats', sa.Column('niche', sa.String(50), nullable=True))

# –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞
op.add_column('monitored_chats', sa.Column('platform', sa.String(20), server_default='telegram', nullable=False))
```

---

## –°–ï–ö–¶–ò–Ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SQLAlchemy-–º–æ–¥–µ–ª–µ–π

–û–±–Ω–æ–≤–∏ –∫–∞–∂–¥—É—é –º–æ–¥–µ–ª—å, –¥–æ–±–∞–≤–∏–≤ –Ω–æ–≤—ã–µ –ø–æ–ª—è. –ù–µ —É–¥–∞–ª—è–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è.

### `src/models/order.py`

–î–æ–±–∞–≤—å –ø–æ–ª—è:
```python
platform = Column(String(20), default='telegram', nullable=False)
niche = Column(String(50), nullable=True)
unit = Column(String(30), nullable=True)  # —Ç–æ–Ω–Ω, –º¬≥, —à—Ç, –≤–∞–≥–æ–Ω, —Ä—É–ª–æ–Ω
volume_numeric = Column(Numeric(12, 2), nullable=True)
```

### `src/models/deal.py`

–î–æ–±–∞–≤—å enum –∏ –ø–æ–ª—è:
```python
class LeadSource(str, enum.Enum):
    SYSTEM = "system"
    MANAGER = "manager"

class DealModel(str, enum.Enum):
    AGENCY = "agency"
    TRANSIT = "transit"

class PaymentStatus(str, enum.Enum):
    PENDING = "pending"
    INVOICED = "invoiced"
    PAID = "paid"
    CONFIRMED = "confirmed"

# –í –∫–ª–∞—Å—Å–µ DetectedDeal:
lead_source = Column(String(20), default='system', nullable=False)
niche = Column(String(50), nullable=True)
deal_model = Column(String(20), default='agency', nullable=False)
manager_commission_rate = Column(Numeric(5, 4), nullable=True)
buyer_payment_status = Column(String(20), default='pending', nullable=False)
seller_payment_status = Column(String(20), default='pending', nullable=False)
our_commission_status = Column(String(20), default='pending', nullable=False)
payment_method = Column(String(20), nullable=True)
ai_draft_message = Column(Text, nullable=True)
market_price_context = Column(Text, nullable=True)  # JSON string
platform = Column(String(20), default='telegram', nullable=False)
```

### `src/models/user.py`

```python
niches = Column(Text, nullable=True)  # JSON: ["construction"]
level = Column(String(20), default='junior', nullable=False)
telegram_user_id = Column(BigInteger, nullable=True)
```

### `src/models/chat.py`

```python
niche = Column(String(50), nullable=True)
platform = Column(String(20), default='telegram', nullable=False)
```

### `src/models/ledger.py`

```python
deal_model = Column(String(20), nullable=True)
commission_rate_applied = Column(Numeric(5, 4), nullable=True)
lead_source = Column(String(20), nullable=True)
```

---

## –°–ï–ö–¶–ò–Ø 3: –ü–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

**–≠—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –∏–∑–º–µ–Ω–µ–Ω–∏–µ.** –¢–µ–∫—É—â–∏–π –ø–∞—Ä—Å–µ—Ä –∑–∞—Ç–æ—á–µ–Ω –ø–æ–¥ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫—É (iPhone, Samsung, MacBook). –ù—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ regex –∏ keywords –¥–ª—è B2B-–æ–ø—Ç–∞ —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.

### `src/services/message_handler.py`

#### 3.1 –ó–∞–º–µ–Ω–∏—Ç—å BUY_KEYWORDS –∏ SELL_KEYWORDS

–¢–µ–∫—É—â–∏–µ keywords –æ—Å—Ç–∞–≤—å, –Ω–æ –†–ê–°–®–ò–†–¨ –¥–ª—è B2B-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```python
BUY_KEYWORDS = [
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    "–∫—É–ø–ª—é", "–ø–æ–∫—É–ø–∞—é", "–∏—â—É", "–Ω—É–∂–µ–Ω", "–Ω—É–∂–Ω–∞", "–Ω—É–∂–Ω–æ", "–ø—Ä–∏–º—É", "–≤–æ–∑—å–º—É",
    # B2B –æ–ø—Ç–æ–≤—ã–µ
    "–∑–∞–∫—É–ø–∞—é", "–∑–∞–∫—É–ø–∞–µ–º", "–∑–∞–∫—É–ø–∏–º", "–ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å", "–∑–∞—è–≤–∫–∞ –Ω–∞",
    "–Ω—É–∂–µ–Ω –æ–±—ä—ë–º", "–Ω—É–∂–µ–Ω –æ–±—ä–µ–º", "—Ç—Ä–µ–±—É–µ—Ç—Å—è", "–≥–æ—Ç–æ–≤—ã –∫—É–ø–∏—Ç—å",
    "–≥–æ—Ç–æ–≤—ã –≤–∑—è—Ç—å", "–∏—â–µ–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞", "–∑–∞–ø—Ä–æ—Å –Ω–∞", "–∫—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç",
    "–∫—Ç–æ –ø—Ä–æ–¥–∞–µ—Ç", "–µ—Å—Ç—å —É –∫–æ–≥–æ", "–ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ", "—Å–∫–∏–Ω—å—Ç–µ —Ü–µ–Ω—É",
    "–∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞", "–∫—Ç–æ –º–æ–∂–µ—Ç –ø–æ—Å—Ç–∞–≤–∏—Ç—å", "–Ω—É–∂–Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∞",
]

SELL_KEYWORDS = [
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    "–ø—Ä–æ–¥–∞–º", "–ø—Ä–æ–¥–∞—é", "–æ—Ç–¥–∞–º", "–µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏", "–≤ –Ω–∞–ª–∏—á–∏–∏", "–≥–æ—Ç–æ–≤ –ø—Ä–æ–¥–∞—Ç—å",
    # B2B –æ–ø—Ç–æ–≤—ã–µ
    "–ø—Ä–æ–¥–∞—ë–º", "–ø—Ä–æ–¥–∞–µ–º", "—Ä–µ–∞–ª–∏–∑—É–µ–º", "—Ä–µ–∞–ª–∏–∑—É—é", "–æ—Å—Ç–∞—Ç–∫–∏",
    "—Å—Ç–æ–∫", "—Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞", "–ª–∏–∫–≤–∏–¥–∞—Ü–∏—è —Å–∫–ª–∞–¥–∞", "–ø–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏",
    "–æ—Ç–≥—Ä—É–∑–∫–∞ —Å–æ —Å–∫–ª–∞–¥–∞", "–æ—Ç–≥—Ä—É–∑–∏–º", "–ø–æ—Å—Ç–∞–≤–∏–º", "–ø–æ—Å—Ç–∞–≤–ª—è–µ–º",
    "–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º", "–ø—Ä–µ–¥–ª–∞–≥–∞—é", "–µ—Å—Ç—å –æ–±—ä—ë–º", "–µ—Å—Ç—å –æ–±—ä–µ–º",
    "—Å–≤–æ–±–æ–¥–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫", "–Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ", "—Å–∫–ª–∞–¥ –º–æ—Å–∫–≤–∞",
    "—Å–∫–ª–∞–¥ –º—Å–∫", "—Å –∑–∞–≤–æ–¥–∞", "–æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è", "–æ–ø—Ç",
]
```

#### 3.2 –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ regex

–£–¥–∞–ª–∏ –≤–µ—Å—å –±–ª–æ–∫ —Å iPhone/Samsung/MacBook. –ó–∞–º–µ–Ω–∏ –Ω–∞:

```python
# –°—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∏—à–∞
CONSTRUCTION_PRODUCTS = {
    # –ú–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç
    r'–∞—Ä–º–∞—Ç—É—Ä[–∞—ã—É–µ]?\s*[–ê–∞Aa]?\s*\d*[–°—ÅCc]?\d*': '–∞—Ä–º–∞—Ç—É—Ä–∞',
    r'–ø—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª\w*': '–ø—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª',
    r'–ø—Ä–æ—Ñ–ª–∏—Å—Ç\w*': '–ø—Ä–æ—Ñ–ª–∏—Å—Ç',
    r'–ª–∏—Å—Ç\s*(–≥–æ—Ä—è—á–µ|—Ö–æ–ª–æ–¥–Ω–æ)?–∫–∞—Ç–∞–Ω\w*': '–ª–∏—Å—Ç —Å—Ç–∞–ª—å–Ω–æ–π',
    r'—Ç—Ä—É–±[–∞—ã—É–µ]?\s*(–ø—Ä–æ—Ñ–∏–ª—å–Ω|–∫—Ä—É–≥–ª–∞—è|—Å—Ç–∞–ª—å–Ω|–í–ì–ü|—ç–ª–µ–∫—Ç—Ä–æ—Å–≤–∞—Ä–Ω)?\w*': '—Ç—Ä—É–±–∞',
    r'—à–≤–µ–ª–ª–µ—Ä\w*': '—à–≤–µ–ª–ª–µ—Ä',
    r'–¥–≤—É—Ç–∞–≤—Ä\w*': '–¥–≤—É—Ç–∞–≤—Ä',
    r'–±–∞–ª–∫[–∞–∏—É]\w*': '–±–∞–ª–∫–∞',
    r'—É–≥–æ–ª[–æ–æ]?–∫?\w*\s*(—Å—Ç–∞–ª—å–Ω|—Ä–∞–≤–Ω–æ–ø–æ–ª–æ—á–Ω|–Ω–µ—Ä–∞–≤–Ω–æ–ø–æ–ª–æ—á–Ω)?\w*': '—É–≥–æ–ª–æ–∫',
    r'–∫—Ä—É–≥–ª?—è?–∫?\w*\s*\d+': '–∫—Ä—É–≥ —Å—Ç–∞–ª—å–Ω–æ–π',
    r'–º–µ—Ç–∞–ª{1,2}–æ–ø—Ä–æ–∫–∞—Ç\w*': '–º–µ—Ç–∞–ª–ª–æ–ø—Ä–æ–∫–∞—Ç',
    r'–Ω–µ—Ä–∂–∞–≤\w+': '–Ω–µ—Ä–∂–∞–≤–µ–π–∫–∞',
    r'–æ—Ü–∏–Ω–∫–æ–≤\w+': '–æ—Ü–∏–Ω–∫–æ–≤–∫–∞',

    # –ë–µ—Ç–æ–Ω –∏ —Ü–µ–º–µ–Ω—Ç
    r'—Ü–µ–º–µ–Ω—Ç\w*\s*[–ú–ºMm]?\s*\d*': '—Ü–µ–º–µ–Ω—Ç',
    r'–±–µ—Ç–æ–Ω\w*\s*[–ú–ºBb–í–≤]?\s*\d*': '–±–µ—Ç–æ–Ω',
    r'–ø–µ—Å–∫–æ–±–µ—Ç–æ–Ω\w*': '–ø–µ—Å–∫–æ–±–µ—Ç–æ–Ω',
    r'—Ä–∞—Å—Ç–≤–æ—Ä\w*\s*(–∫–ª–∞–¥–æ—á–Ω|—à—Ç—É–∫–∞—Ç—É—Ä–Ω)?\w*': '—Ä–∞—Å—Ç–≤–æ—Ä',
    r'–ñ–ë–ò|–∂–±–∏': '–ñ–ë–ò',
    r'–ø–ª–∏—Ç[–∞—ã—É]\s*(–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è|–¥–æ—Ä–æ–∂–Ω|–ü–ö|–ü–ë)\w*': '–ø–ª–∏—Ç–∞',

    # –ü–∏–ª–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã
    r'–¥–æ—Å–∫[–∞–∏—É]\w*\s*(–æ–±—Ä–µ–∑–Ω|–Ω–µ–æ–±—Ä–µ–∑–Ω|—Å—Ç—Ä–æ–≥–∞–Ω)?\w*': '–¥–æ—Å–∫–∞',
    r'–±—Ä—É—Å\w*\s*\d*[—Öx√ó]\d*': '–±—Ä—É—Å',
    r'—Ñ–∞–Ω–µ—Ä[–∞—ã—É]\w*': '—Ñ–∞–Ω–µ—Ä–∞',
    r'OSB|–û–°–ü|–æ—Å–±': 'OSB',
    r'–ø–∏–ª–æ–º–∞—Ç–µ—Ä–∏–∞–ª\w*': '–ø–∏–ª–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã',
    r'–≤–∞–≥–æ–Ω–∫[–∞–∏—É]\w*': '–≤–∞–≥–æ–Ω–∫–∞',

    # –ö—Ä–æ–≤–ª—è –∏ –∏–∑–æ–ª—è—Ü–∏—è
    r'—É—Ç–µ–ø–ª–∏—Ç–µ–ª[—å—è]\w*': '—É—Ç–µ–ø–ª–∏—Ç–µ–ª—å',
    r'(–º–∏–Ω|–º–∏–Ω–µ—Ä–∞–ª\w*)\s*–≤–∞—Ç[–∞—ã—É]\w*': '–º–∏–Ω–≤–∞—Ç–∞',
    r'–ø–µ–Ω–æ–ø–ª–∞—Å—Ç\w*': '–ø–µ–Ω–æ–ø–ª–∞—Å—Ç',
    r'–ø–µ–Ω–æ–ø–ª–µ–∫—Å\w*': '–ø–µ–Ω–æ–ø–ª–µ–∫—Å',
    r'(–º—è–≥–∫|—Ä—É–ª–æ–Ω–Ω)\w*\s*–∫—Ä–æ–≤–ª\w*': '–∫—Ä–æ–≤–ª—è –º—è–≥–∫–∞—è',
    r'—á–µ—Ä–µ–ø–∏—Ü[–∞—ã—É]\w*': '—á–µ—Ä–µ–ø–∏—Ü–∞',
    r'–º–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü[–∞—ã—É]\w*': '–º–µ—Ç–∞–ª–ª–æ—á–µ—Ä–µ–ø–∏—Ü–∞',

    # –°—ã–ø—É—á–∏–µ
    r'–ø–µ—Å–æ?–∫\w*\s*(–∫–∞—Ä—å–µ—Ä–Ω|—Ä–µ—á–Ω|—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω)?\w*': '–ø–µ—Å–æ–∫',
    r'—â–µ–±–µ–Ω[—å—è]\w*|—â–µ–±–Ω\w*|—â–µ–±—ë–Ω–∫\w*': '—â–µ–±–µ–Ω—å',
    r'–ü–ì–°|–ø–≥—Å|–ø–µ—Å—á–∞–Ω–æ[\s-]–≥—Ä–∞–≤–∏–π–Ω\w*': '–ü–ì–°',
    r'–∫–µ—Ä–∞–º–∑–∏—Ç\w*': '–∫–µ—Ä–∞–º–∑–∏—Ç',
    r'–≥—Ä—É–Ω—Ç\w*': '–≥—Ä—É–Ω—Ç',

    # –ö–∏—Ä–ø–∏—á –∏ –±–ª–æ–∫–∏
    r'–∫–∏—Ä–ø–∏—á\w*\s*(–∫–µ—Ä–∞–º–∏—á|—Å–∏–ª–∏–∫–∞—Ç|–æ–±–ª–∏—Ü–æ–≤|—Ä—è–¥–æ–≤)?\w*': '–∫–∏—Ä–ø–∏—á',
    r'–≥–∞–∑–æ–±–µ—Ç–æ–Ω\w*|–≥–∞–∑–æ–±–ª–æ–∫\w*': '–≥–∞–∑–æ–±–µ—Ç–æ–Ω',
    r'–ø–µ–Ω–æ–±–µ—Ç–æ–Ω\w*|–ø–µ–Ω–æ–±–ª–æ–∫\w*': '–ø–µ–Ω–æ–±–ª–æ–∫',
    r'–∫–µ—Ä–∞–º–∑–∏—Ç–æ–±–µ—Ç–æ–Ω\w*|–∫–µ—Ä–∞–º–∑–∏—Ç–æ–±–ª–æ–∫\w*': '–∫–µ—Ä–∞–º–∑–∏—Ç–æ–±–ª–æ–∫',
    r'–±–ª–æ–∫\w*\s*(—Å—Ç–µ–Ω–æ–≤|—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–Ω|–±–µ—Ç–æ–Ω–Ω)?\w*': '–±–ª–æ–∫',

    # –°—É—Ö–∏–µ —Å–º–µ—Å–∏
    r'—à—Ç—É–∫–∞—Ç—É—Ä–∫[–∞–∏—É]\w*': '—à—Ç—É–∫–∞—Ç—É—Ä–∫–∞',
    r'—à–ø–∞—Ç–ª—ë–≤–∫[–∞–∏—É]\w*|—à–ø–∞–∫–ª—ë–≤–∫[–∞–∏—É]\w*': '—à–ø–∞—Ç–ª—ë–≤–∫–∞',
    r'–∫–ª–µ–π\w*\s*(–ø–ª–∏—Ç–æ—á–Ω|–¥–ª—è\s+–±–ª–æ–∫–æ–≤)?\w*': '–∫–ª–µ–π',
    r'–Ω–∞–ª–∏–≤–Ω–æ[–π–µ]\s*–ø–æ–ª\w*': '–Ω–∞–ª–∏–≤–Ω–æ–π –ø–æ–ª',
    r'–≥—Ä—É–Ω—Ç–æ–≤–∫[–∞–∏—É]\w*': '–≥—Ä—É–Ω—Ç–æ–≤–∫–∞',

    # –ö—Ä–µ–ø—ë–∂
    r'—Å–∞–º–æ—Ä–µ–∑\w*': '—Å–∞–º–æ—Ä–µ–∑—ã',
    r'–≥–≤–æ–∑–¥[—å–∏–µ–π]\w*': '–≥–≤–æ–∑–¥–∏',
    r'–∞–Ω–∫–µ—Ä\w*': '–∞–Ω–∫–µ—Ä—ã',
}

# –ê–≥—Ä–æ ‚Äî –≤—Ç–æ—Ä–∞—è –Ω–∏—à–∞ (–Ω–∞ –±—É–¥—É—â–µ–µ, –ø–æ–∫–∞ –Ω–µ –ø–∞—Ä—Å–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ)
AGRICULTURE_PRODUCTS = {
    r'–ø—à–µ–Ω–∏—Ü[–∞—ã—É]\w*': '–ø—à–µ–Ω–∏—Ü–∞',
    r'—è—á–º–µ–Ω[—å—è]\w*': '—è—á–º–µ–Ω—å',
    r'–∫—É–∫—É—Ä—É–∑[–∞—ã—É]\w*': '–∫—É–∫—É—Ä—É–∑–∞',
    r'–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫\w*|—Å–µ–º–µ—á–∫\w*': '–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫',
    r'—Å–æ–µ–≤?\w*\s*(–±–æ–±—ã|—à—Ä–æ—Ç|–º–∞—Å–ª–æ)?': '—Å–æ—è',
    r'—Å–∞—Ö–∞—Ä\w*\s*(–ø–µ—Å–æ–∫)?': '—Å–∞—Ö–∞—Ä',
    r'–º–∞—Å–ª–æ\s*(–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω|—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω)\w*': '–º–∞—Å–ª–æ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ',
    r'–º—É–∫[–∞–∏—É]\w*': '–º—É–∫–∞',
}

# –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
PRODUCT_PATTERNS = {**CONSTRUCTION_PRODUCTS}
# –ö–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏—à—å –≤—Ç–æ—Ä—É—é –Ω–∏—à—É: PRODUCT_PATTERNS = {**CONSTRUCTION_PRODUCTS, **AGRICULTURE_PRODUCTS}
```

#### 3.3 –û–±–Ω–æ–≤–∏—Ç—å `detect_order_type()` –∏ `extract_product()`

```python
def extract_product(text: str) -> tuple[str | None, str | None]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç –∏ –Ω–∏—à—É –∏–∑ —Ç–µ–∫—Å—Ç–∞.

    Returns:
        (product_name, niche) ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä ('–∞—Ä–º–∞—Ç—É—Ä–∞ –ê500–°', 'construction')
    """
    text_lower = text.lower()

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã
    for pattern, product_name in CONSTRUCTION_PRODUCTS.items():
        if re.search(pattern, text_lower, re.IGNORECASE):
            # –ò–∑–≤–ª–µ—á—å –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –º–∞—Ä–∫—É/—Ä–∞–∑–º–µ—Ä)
            match = re.search(pattern, text_lower, re.IGNORECASE)
            full_product = match.group(0).strip()
            return (full_product or product_name, 'construction')

    # –ü–æ—Ç–æ–º –∞–≥—Ä–æ (–∫–æ–≥–¥–∞ –≤–∫–ª—é—á–∏–º)
    # for pattern, product_name in AGRICULTURE_PRODUCTS.items():
    #     ...
    #     return (product_name, 'agriculture')

    return (None, None)
```

#### 3.4 –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä —Ü–µ–Ω –¥–ª—è –æ–ø—Ç–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

–¢–µ–∫—É—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ü–µ–Ω —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å B2B-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ:

```python
PRICE_PATTERNS_EXTRA = [
    # "48 500 —Ä—É–±/—Ç–æ–Ω–Ω–∞", "3200 –∑–∞ –º¬≥"
    r'(\d[\d\s.,]*\d)\s*(?:—Ä—É–±|‚ÇΩ|—Ä)?\s*[/–∑–∞]\s*(—Ç–æ–Ω–Ω[–∞—ã—É]?|—Ç\b|–º[¬≤¬≥23]|–∫—É–±|—à—Ç|—Ä—É–ª–æ–Ω|–ª–∏—Å—Ç|–º–µ—à–æ–∫|–ø–æ–¥–¥–æ–Ω|–≤–∞–≥–æ–Ω)',
    # "–æ—Ç 45000", "–æ—Ç 45 000"
    r'–æ—Ç\s+(\d[\d\s.,]*\d)\s*(?:—Ä—É–±|‚ÇΩ|—Ä)?',
    # –î–∏–∞–ø–∞–∑–æ–Ω: "45-52 —Ç—ã—Å"
    r'(\d[\d\s.,]*\d)\s*[-‚Äì]\s*(\d[\d\s.,]*\d)\s*(?:—Ç—ã—Å|—Ä—É–±|‚ÇΩ)',
]

UNIT_PATTERNS = [
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(—Ç–æ–Ω–Ω[–∞—ã—É]?|—Ç\b)', '—Ç–æ–Ω–Ω–∞'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–º[¬≤2]|–∫–≤\.?\s*–º)', '–º¬≤'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–º[¬≥3]|–∫—É–±\.?\s*–º)', '–º¬≥'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(—à—Ç|—à—Ç—É–∫)', '—à—Ç'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(—Ä—É–ª–æ–Ω)', '—Ä—É–ª–æ–Ω'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–ª–∏—Å—Ç)', '–ª–∏—Å—Ç'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–º–µ—à–æ–∫|–º–µ—à–∫)', '–º–µ—à–æ–∫'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–ø–æ–¥–¥–æ–Ω)', '–ø–æ–¥–¥–æ–Ω'),
    (r'(?:—Ä—É–±|‚ÇΩ|—Ä)\s*/?\s*(–≤–∞–≥–æ–Ω)', '–≤–∞–≥–æ–Ω'),
]
```

#### 3.5 –ü–∞—Ä—Å–µ—Ä –æ–±—ä—ë–º–æ–≤

–î–æ–±–∞–≤—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é:

```python
def extract_volume(text: str) -> tuple[float | None, str | None]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –æ–±—ä—ë–º –∏ –µ–¥–∏–Ω–∏—Ü—É –∏–∑ —Ç–µ–∫—Å—Ç–∞.

    –ü—Ä–∏–º–µ—Ä—ã:
        '20 —Ç–æ–Ω–Ω' ‚Üí (20.0, '—Ç–æ–Ω–Ω–∞')
        '1 –≤–∞–≥–æ–Ω' ‚Üí (1.0, '–≤–∞–≥–æ–Ω')
        '500 –º¬≤' ‚Üí (500.0, '–º¬≤')
        '3 —Ñ—É—Ä—ã' ‚Üí (3.0, '—Ñ—É—Ä–∞')
    """
    VOLUME_PATTERNS = [
        (r'(\d[\d\s.,]*\d?)\s*(—Ç–æ–Ω–Ω[–∞—ã—É]?|—Ç\b)', '—Ç–æ–Ω–Ω–∞'),
        (r'(\d[\d\s.,]*\d?)\s*(–≤–∞–≥–æ–Ω\w*)', '–≤–∞–≥–æ–Ω'),
        (r'(\d[\d\s.,]*\d?)\s*(—Ñ—É—Ä[–∞—ã—É]\w*|–º–∞—à–∏–Ω[–∞—ã—É]\w*)', '—Ñ—É—Ä–∞'),
        (r'(\d[\d\s.,]*\d?)\s*(–º[¬≤2]|–∫–≤\.?\s*–º\w*)', '–º¬≤'),
        (r'(\d[\d\s.,]*\d?)\s*(–º[¬≥3]|–∫—É–±\.?\s*–º\w*)', '–º¬≥'),
        (r'(\d[\d\s.,]*\d?)\s*(—à—Ç|—à—Ç—É–∫\w*)', '—à—Ç'),
        (r'(\d[\d\s.,]*\d?)\s*(—Ä—É–ª–æ–Ω\w*)', '—Ä—É–ª–æ–Ω'),
        (r'(\d[\d\s.,]*\d?)\s*(–ª–∏—Å—Ç\w*)', '–ª–∏—Å—Ç'),
        (r'(\d[\d\s.,]*\d?)\s*(–ø–æ–¥–¥–æ–Ω\w*|–ø–∞–ª–µ—Ç\w*)', '–ø–æ–¥–¥–æ–Ω'),
        (r'(\d[\d\s.,]*\d?)\s*(–º–µ—à–∫\w*|–º–µ—à–æ–∫)', '–º–µ—à–æ–∫'),
        (r'(\d[\d\s.,]*\d?)\s*(–ø–∞—á[–µ–∫]\w*|–ø–∞—á–∫–∞)', '–ø–∞—á–∫–∞'),
    ]
    for pattern, unit in VOLUME_PATTERNS:
        match = re.search(pattern, text.lower())
        if match:
            num_str = match.group(1).replace(' ', '').replace(',', '.')
            try:
                return (float(num_str), unit)
            except ValueError:
                continue
    return (None, None)
```

#### 3.6 –û–±–Ω–æ–≤–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –º–∞—Ç—á–∏–Ω–≥–∞ `_products_match`

–¢–µ–∫—É—â–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å "–ª—é–±–æ–µ –æ–±—â–µ–µ —Å–ª–æ–≤–æ ‚â•4 —Å–∏–º–≤–æ–ª–æ–≤" —Å–ª–∏—à–∫–æ–º –Ω–µ—á—ë—Ç–∫–∏–π –¥–ª—è —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –£—Å–∏–ª–∏—Ç—å:

```python
def _products_match(product_a: str, product_b: str) -> bool:
    """–ú–∞—Ç—á–∏–Ω–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è B2B-–æ–ø—Ç–∞.

    –ü—Ä–∞–≤–∏–ª–∞:
    1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: lower + —É–¥–∞–ª–∏—Ç—å –º–∞—Ä–∫–∏ (–ê500–°, –ú500, –í25)
    2. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è ‚Üí True
    3. –ö–æ—Ä–Ω–µ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: '–∞—Ä–º–∞—Ç—É—Ä–∞' ‚Üî '–∞—Ä–º–∞—Ç—É—Ä—É' ‚Üí True
    4. –ö–∞—Ç–µ–≥–æ—Ä–∏–π–Ω–æ–µ: '–ø—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª' ‚Üî '–ø—Ä–æ—Ñ–ª–∏—Å—Ç' ‚Üí True (—Å–∏–Ω–æ–Ω–∏–º—ã)
    5. –ò–Ω–∞—á–µ: ‚â•50% –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∑–Ω–∞—á–∏–º—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (‚â•4 —Å–∏–º–≤–æ–ª–æ–≤)
    """
    SYNONYMS = {
        frozenset({'–ø—Ä–æ—Ñ–Ω–∞—Å—Ç–∏–ª', '–ø—Ä–æ—Ñ–ª–∏—Å—Ç'}),
        frozenset({'–¥–æ—Å–∫–∞', '–ø–∏–ª–æ–º–∞—Ç–µ—Ä–∏–∞–ª'}),
        frozenset({'–≥–∞–∑–æ–±–µ—Ç–æ–Ω', '–≥–∞–∑–æ–±–ª–æ–∫'}),
        frozenset({'–ø–µ–Ω–æ–±–ª–æ–∫', '–ø–µ–Ω–æ–±–µ—Ç–æ–Ω'}),
        frozenset({'—â–µ–±–µ–Ω—å', '—â–µ–±—ë–Ω–∫–∞'}),
        frozenset({'–º–∏–Ω–≤–∞—Ç–∞', '—É—Ç–µ–ø–ª–∏—Ç–µ–ª—å'}),
    }

    a = _normalize_product(product_a)
    b = _normalize_product(product_b)

    if a == b:
        return True

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω–æ–Ω–∏–º—ã
    for syn_group in SYNONYMS:
        if a in syn_group and b in syn_group:
            return True

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–ø–µ—Ä–≤—ã–µ 5 —Å–∏–º–≤–æ–ª–æ–≤)
    if len(a) >= 5 and len(b) >= 5 and a[:5] == b[:5]:
        return True

    # –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è
    tokens_a = {t for t in a.split() if len(t) >= 4}
    tokens_b = {t for t in b.split() if len(t) >= 4}
    if not tokens_a or not tokens_b:
        return False

    intersection = tokens_a & tokens_b
    min_len = min(len(tokens_a), len(tokens_b))
    return len(intersection) / min_len >= 0.5


def _normalize_product(product: str) -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –º–∞—Ç—á–∏–Ω–≥–∞."""
    text = product.lower().strip()
    # –£–±—Ä–∞—Ç—å –º–∞—Ä–∫–∏: –ê500–°, –ú500, –í25, D500, F150
    text = re.sub(r'[–ê–∞Aa]\d+[–°—ÅCc–í–≤Bb]?\d*', '', text)
    text = re.sub(r'[–ú–ºMm]\d+', '', text)
    text = re.sub(r'[–í–≤Bb]\d+', '', text)
    text = re.sub(r'[Dd–î–¥]\d+', '', text)
    text = re.sub(r'[Ff–§—Ñ]\d+', '', text)
    # –£–±—Ä–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã: 12–º–º, 150x150, ‚àÖ10
    text = re.sub(r'\d+\s*[—Öx√ó]\s*\d+', '', text)
    text = re.sub(r'[‚àÖ‚åÄ]?\d+\s*–º–º', '', text)
    return re.sub(r'\s+', ' ', text).strip()
```

#### 3.7 –û–±–Ω–æ–≤–∏—Ç—å `_process_message_internal` ‚Äî –∑–∞–ø–æ–ª–Ω—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Order ‚Äî –∑–∞–ø–æ–ª–Ω—è–π `platform`, `niche`, `unit`, `volume_numeric`:

```python
# –í –º–µ—Å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è Order:
product, niche = extract_product(text)
volume, unit = extract_volume(text)

order = Order(
    order_type=order_type,
    chat_id=chat_id,
    sender_id=sender_id,
    message_id=message_id,
    product=product,
    price=price,
    quantity=quantity_str,  # –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    region=region,
    raw_text=text,
    contact_info=phone,
    platform='telegram',  # –•–∞—Ä–¥–∫–æ–¥ –ø–æ–∫–∞ –ø–∞—Ä—Å–∏–º —Ç–æ–ª—å–∫–æ TG
    niche=niche,
    unit=unit,
    volume_numeric=volume,
)
```

#### 3.8 –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω –¥–ª—è —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤

–¢–µ–∫—É—â–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: 1000‚Äì10,000,000. –î–ª—è —Å—Ç—Ä–æ–π–∫–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å:

```python
# –¶–µ–Ω–∞ –ó–ê –ï–î–ò–ù–ò–¶–£: –æ—Ç 100 —Ä—É–± (—Å–∞–º–æ—Ä–µ–∑—ã/—à—Ç) –¥–æ 200,000 —Ä—É–± (—Å–ø–µ—Ü—Å—Ç–∞–ª—å/—Ç–æ–Ω–Ω–∞)
PRICE_MIN = 100
PRICE_MAX = 500_000  # –∑–∞ –µ–¥–∏–Ω–∏—Ü—É

# –¶–µ–Ω–∞ –ó–ê –û–ë–™–Å–ú: –æ—Ç 5,000 –¥–æ 50,000,000 (–≤–∞–≥–æ–Ω –∑–µ—Ä–Ω–∞)
TOTAL_PRICE_MIN = 5_000
TOTAL_PRICE_MAX = 50_000_000
```

---

## –°–ï–ö–¶–ò–Ø 4: AI-–≤–æ—Ä–∫—Ñ–ª–æ—É ‚Äî –ö–æ–ø–∏–ª–æ—Ç –≤–º–µ—Å—Ç–æ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç–∞

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ü–û–í–ï–î–ï–ù–ò–Ø.** –°–µ–π—á–∞—Å AI –∞–≤—Ç–æ–Ω–æ–º–Ω–æ –ø–∏—à–µ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞–º/–ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å:

### 4.1 –ù–æ–≤—ã–π —Ñ–ª–æ—É –¥–ª—è –°–ò–°–¢–ï–ú–ù–´–• –ª–∏–¥–æ–≤

```
1. AI –ø–∞—Ä—Å–∏—Ç —á–∞—Ç—ã ‚Üí –º–∞—Ç—á–∏—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç DetectedDeal (status=COLD)
2. AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ai_draft_message + market_price_context ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Å–¥–µ–ª–∫—É
3. –°–¥–µ–ª–∫–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–∞–∫ "–ù–æ–≤—ã–π –ª–∏–¥"
4. –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç–æ—á–∫—É: —Ç–æ–≤–∞—Ä, —Ü–µ–Ω–∞, –º–∞—Ä–∂–∞, —Ä—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç, –¥—Ä–∞—Ñ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
5. –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç [–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä–∞—Ñ—Ç] / [–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å] / [–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å]
6. –°–æ–æ–±—â–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –æ—Ç –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–µ–≥–æ Telegram-–∞–∫–∫–∞—É–Ω—Ç)
7. –î–∞–ª—å–Ω–µ–π—à–∏–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ã ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä –≤—Ä—É—á–Ω—É—é, AI –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç
```

### 4.2 –ò–∑–º–µ–Ω–∏—Ç—å `initiate_negotiation()` –≤ `message_handler.py`

–í–º–µ—Å—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥—Ä–∞—Ñ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–π:

```python
async def initiate_negotiation(self, deal: DetectedDeal, ...):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI-–¥—Ä–∞—Ñ—Ç –∏ —Ä—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç. –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ."""

    # –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—Ä–∞—Ñ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    draft = await self._generate_initial_draft(deal)

    # –°–æ–±—Ä–∞—Ç—å —Ä—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∏–∑ parsed messages)
    context = await self._build_market_context(deal.product, deal.niche)

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–¥–µ–ª–∫—É
    deal.ai_draft_message = draft
    deal.market_price_context = json.dumps(context, ensure_ascii=False)
    deal.status = DealStatus.COLD  # –ñ–¥—ë—Ç –¥–µ–π—Å—Ç–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞

    # –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å Negotiation, –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    # Negotiation —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –±–µ—Ä—ë—Ç —Å–¥–µ–ª–∫—É
```

### 4.3 –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å: `src/services/ai_copilot.py`

–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Ñ–∞–π–ª:

```python
"""AI Copilot ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç:
- –î—Ä–∞—Ñ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤
- –ü–µ—Ä–µ—Å—á—ë—Ç –º–∞—Ä–∂–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã
- –†—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
"""

class AICopilot:
    async def generate_initial_draft(self, deal: DetectedDeal) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥—Ä–∞—Ñ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü—É.

        –§–æ—Ä–º–∞—Ç: –∫–æ—Ä–æ—Ç–∫–æ–µ, —á–µ–ª–æ–≤–µ—á–Ω–æ–µ, –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.
        –ù–ï '–º—ã –∫–æ–º–ø–∞–Ω–∏—è Arbion'. –ê '–ü—Ä–∏–≤–µ—Ç! –ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–° –µ—â—ë –∞–∫—Ç—É–∞–ª—å–Ω–∞? –ö–∞–∫–æ–π –æ–±—ä—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π?'
        """
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM –∏–ª–∏ —à–∞–±–ª–æ–Ω—ã
        pass

    async def suggest_responses(self, negotiation_id: int, last_message: str) -> list[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞."""
        pass

    async def recalculate_margin(self, deal_id: int, new_price: float, side: str) -> dict:
        """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ä–∂—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã.

        Returns: {
            "old_margin": 3000,
            "new_margin": 3500,
            "margin_percent": 7.3,
            "recommendation": "–•–æ—Ä–æ—à–∞—è —Ü–µ–Ω–∞, –º–∞—Ä–∂–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 500‚ÇΩ/—Ç–æ–Ω–Ω–∞"
        }
        """
        pass

    async def build_market_context(self, product: str, niche: str) -> dict:
        """–°–æ–±–∏—Ä–∞–µ—Ç —Ü–µ–Ω–æ–≤–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö parsed messages.

        Returns: {
            "avg_price": 48500,
            "min_seen": 45000,
            "max_seen": 52000,
            "sources_count": 12,
            "last_7_days": [...],
            "trend": "stable" | "rising" | "falling"
        }
        """
        pass
```

### 4.4 –û—Å—Ç–∞–≤–∏—Ç—å AI-–∞–≤—Ç–æ–ø–∏–ª–æ—Ç –∫–∞–∫ –û–ü–¶–ò–Æ (–Ω–µ —É–¥–∞–ª—è—Ç—å!)

–í `SystemSetting` –¥–æ–±–∞–≤—å:

```python
# –†–µ–∂–∏–º AI: 'copilot' (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è) –∏–ª–∏ 'autopilot' (—Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
ai_mode = "copilot"  # default
```

–í–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ai_negotiator.py –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–≥–¥–∞ `ai_mode = "autopilot"`. –ù–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `copilot`.

---

## –°–ï–ö–¶–ò–Ø 5: –¢–∏–µ—Ä–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è

### 5.1 –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏

–í `src/services/deal_router.py` –∏–ª–∏ –Ω–æ–≤–æ–º `src/services/commission.py`:

```python
def calculate_commission_rate(deal: DetectedDeal, manager: User) -> Decimal:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞–≤–∫—É –∫–æ–º–∏—Å—Å–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

    –ü—Ä–∞–≤–∏–ª–∞:
    - –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–∏–¥ (AI –Ω–∞—à—ë–ª –∏ —Å–º–∞—Ç—á–∏–ª): 20%
    - –õ–∏–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–ø—Ä–∏–≤—ë–ª —Å–∞–º): 35%
    - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (user.commission_rate)
    """
    if deal.lead_source == 'manager':
        return Decimal('0.35')

    # –°–∏—Å—Ç–µ–º–Ω—ã–π –ª–∏–¥
    base_rate = Decimal('0.20')

    # –ï—Å–ª–∏ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å—Ç–∞–≤–∫–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë
    if manager.commission_rate is not None:
        return manager.commission_rate

    return base_rate
```

### 5.2 –§–∏–∫—Å–∞—Ü–∏—è –∫–æ–º–∏—Å—Å–∏–∏ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏

–ü—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–∞ —Å–¥–µ–ª–∫—É:

```python
deal.manager_id = manager.id
deal.manager_commission_rate = calculate_commission_rate(deal, manager)
deal.assigned_at = datetime.utcnow()
```

### 5.3 –†–∞—Å—á—ë—Ç –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (LedgerEntry)

```python
# –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ LedgerEntry:
commission_rate = deal.manager_commission_rate or Decimal('0.20')
manager_commission = deal.profit * commission_rate

ledger = LedgerEntry(
    deal_id=deal.id,
    buy_amount=deal.buy_price,
    sell_amount=deal.sell_price,
    profit=deal.margin,
    manager_commission=manager_commission,
    commission_rate_applied=commission_rate,
    deal_model=deal.deal_model,
    lead_source=deal.lead_source,
    closed_by_user_id=current_user.id,
)
```

---

## –°–ï–ö–¶–ò–Ø 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Pydantic-—Å—Ö–µ–º

### `src/schemas/deal.py`

–î–æ–±–∞–≤—å –≤ `OwnerDealResponse`:
```python
lead_source: str | None = None
niche: str | None = None
deal_model: str = "agency"
manager_commission_rate: float | None = None
buyer_payment_status: str = "pending"
seller_payment_status: str = "pending"
our_commission_status: str = "pending"
payment_method: str | None = None
ai_draft_message: str | None = None
market_price_context: str | None = None  # JSON string
platform: str = "telegram"
```

–î–æ–±–∞–≤—å –≤ `ManagerDealResponse`:
```python
lead_source: str | None = None
niche: str | None = None
ai_draft_message: str | None = None
market_price_context: str | None = None  # –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Ä—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
platform: str = "telegram"
# –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å: deal_model, payment statuses, commission (—ç—Ç–æ –¥–ª—è owner)
```

### `src/schemas/user.py`

–í `ManagerResponse`:
```python
niches: list[str] | None = None  # –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–∑ JSON
level: str = "junior"
telegram_user_id: int | None = None
```

### –ù–æ–≤–∞—è —Å—Ö–µ–º–∞: `src/schemas/copilot.py`

```python
class LeadCardResponse(BaseModel):
    """–ö–∞—Ä—Ç–æ—á–∫–∞ –ª–∏–¥–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."""
    deal_id: int
    product: str
    niche: str | None
    sell_price: float
    estimated_margin: float  # Owner –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç buy_price, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–∂–∏–¥–∞–µ–º—É—é –º–∞—Ä–∂—É –≤ %
    volume: str | None
    region: str | None
    seller_city: str | None
    ai_draft_message: str | None
    market_context: dict | None  # Parsed JSON
    created_at: datetime
    platform: str

class SuggestedResponses(BaseModel):
    """–ü–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç AI."""
    variants: list[str]  # 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞
    margin_info: str | None  # "–¢–µ–∫—É—â–∞—è –º–∞—Ä–∂–∞: 3.5–ö/—Ç–æ–Ω–Ω–∞ (7.3%)"
```

---

## –°–ï–ö–¶–ò–Ø 7: API ‚Äî –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### Manager Panel ‚Äî –Ω–æ–≤—ã–µ:

```python
# –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ª–∏–¥–∞ —Å AI-–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
GET /panel/leads/{deal_id}/card ‚Üí LeadCardResponse

# –ú–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç (–∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç) AI-–¥—Ä–∞—Ñ—Ç
POST /panel/leads/{deal_id}/send-draft
    body: { "message": "—Ç–µ–∫—Å—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω)", "target": "seller" | "buyer" }

# –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ª–∏–¥
POST /panel/leads/{deal_id}/skip
    body: { "reason": "low_margin" | "bad_product" | "no_contact" | "other" }

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
GET /panel/chat/{neg_id}/suggestions ‚Üí SuggestedResponses

# –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–∑–¥–∞—ë—Ç —Å–≤–æ–π –ª–∏–¥ (lead_source=manager)
POST /panel/leads/create
    body: { "product": "...", "niche": "construction", "sell_price": 52000, ... }
```

### Admin Panel ‚Äî –Ω–æ–≤—ã–µ:

```python
# –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã —Å–¥–µ–ª–∫–∏
PATCH /admin/deals/{id}/payment
    body: { "buyer_payment_status": "paid", "seller_payment_status": "pending" }

# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –Ω–∏—à–∞–º
GET /admin/analytics/niches ‚Üí { "construction": { deals: 15, revenue: 450000, avg_margin: 30000 }, ... }

# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è)
GET /admin/analytics/managers ‚Üí [ { manager_id, system_deals, manager_deals, commission_total, conversion_rate } ]
```

---

## –°–ï–ö–¶–ò–Ø 8: UI ‚Äî –ö–∞—Ä—Ç–æ—á–∫–∞ –ª–∏–¥–∞ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–æ–π –ø–∞–Ω–µ–ª–∏

### –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ª–∏–¥–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üî• –ù–æ–≤—ã–π –ª–∏–¥ #142                        ‚îÇ
‚îÇ –ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–° ‚Ä¢ –°—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã          ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üìä –†—ã–Ω–æ—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:                    ‚îÇ
‚îÇ –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: 48 500 ‚ÇΩ/—Ç–æ–Ω–Ω–∞            ‚îÇ
‚îÇ –î–∏–∞–ø–∞–∑–æ–Ω: 45 000 ‚Äî 52 000 ‚ÇΩ             ‚îÇ
‚îÇ –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: 12 –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π       ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üí∞ –ü—Ä–æ–¥–∞–≤–µ—Ü: 47 000 ‚ÇΩ/—Ç (20 —Ç–æ–Ω–Ω, –¢—É–ª–∞) ‚îÇ
‚îÇ üí∞ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: 52 000 ‚ÇΩ/—Ç (–ú–æ—Å–∫–≤–∞)      ‚îÇ
‚îÇ üìà –û–∂–∏–¥–∞–µ–º–∞—è –º–∞—Ä–∂–∞: ~5 000 ‚ÇΩ/—Ç (10.6%)  ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ üí¨ AI-–¥—Ä–∞—Ñ—Ç:                             ‚îÇ
‚îÇ "–ü—Ä–∏–≤–µ—Ç! –ê—Ä–º–∞—Ç—É—Ä–∞ –ê500–° –µ—â—ë –∞–∫—Ç—É–∞–ª—å–Ω–∞?  ‚îÇ
‚îÇ  –ö–∞–∫–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º? –ï—Å—Ç—å —Å–µ—Ä—Ç?"     ‚îÇ
‚îÇ                                          ‚îÇ
‚îÇ [–û—Ç–ø—Ä–∞–≤–∏—Ç—å] [–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å] [–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `src/templates/panel/lead_card.html` (–Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω).

---

## –°–ï–ö–¶–ò–Ø 9: –ß—Ç–æ –ù–ï —Ç—Ä–æ–≥–∞—Ç—å

- **Auth flow** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–µ –º–µ–Ω—è—Ç—å
- **JWT/cookies** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç
- **Masking** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç
- **Audit** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç
- **OutboxWorker** ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å, –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- **MessageBuffer** ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å
- **Whisper transcription** ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å
- **–í—Å–µ existing API endpoints** ‚Äî –Ω–µ –ª–æ–º–∞—Ç—å, —Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å

---

## –°–ï–ö–¶–ò–Ø 10: –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
–®–∞–≥ 1: –ú–∏–≥—Ä–∞—Ü–∏—è 011 (–°–ï–ö–¶–ò–Ø 1)
–®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å SQLAlchemy-–º–æ–¥–µ–ª–∏ (–°–ï–ö–¶–ò–Ø 2)
–®–∞–≥ 3: –ü–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–°–ï–ö–¶–ò–Ø 3) ‚Äî —Å–∞–º–æ–µ –æ–±—ä—ë–º–Ω–æ–µ
–®–∞–≥ 4: AI Copilot —Å–µ—Ä–≤–∏—Å (–°–ï–ö–¶–ò–Ø 4)
–®–∞–≥ 5: –ö–æ–º–∏—Å—Å–∏—è (–°–ï–ö–¶–ò–Ø 5)
–®–∞–≥ 6: Pydantic-—Å—Ö–µ–º—ã (–°–ï–ö–¶–ò–Ø 6)
–®–∞–≥ 7: –ù–æ–≤—ã–µ API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–°–ï–ö–¶–ò–Ø 7)
–®–∞–≥ 8: UI –∫–∞—Ä—Ç–æ—á–∫–∞ –ª–∏–¥–∞ (–°–ï–ö–¶–ò–Ø 8)

–ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π commit.
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –Ω–µ —Å–ª–æ–º–∞–Ω—ã.
```

---

## –°–ï–ö–¶–ò–Ø 11: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è Claude Code)

### –ü–æ—á–µ–º—É AI –±–æ–ª—å—à–µ –Ω–µ –ø–∏—à–µ—Ç —Å–∞–º?
- "–Ø –±–æ—Ç" = –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –±–ª–æ–∫ –≤ –æ–ø—Ç–æ–≤—ã—Ö —á–∞—Ç–∞—Ö (95% —Å–ø–∞–º-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è)
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –±–æ—Ç–∞: 1-3% vs –º–µ–Ω–µ–¥–∂–µ—Ä —Å AI: 10-20%
- –ë–∞–Ω—Ä–∏—Å–∫ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–µ

### –ü–æ—á–µ–º—É —Å—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–µ—Ä–≤–∞—è –Ω–∏—à–∞?
- 3-8% –º–∞—Ä–∂–∞, 300K-3M ‚ÇΩ —Ä–∞–∑–º–µ—Ä —Å–¥–µ–ª–∫–∏
- 248+ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ –≤ Telegram
- –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ü–µ–Ω = –æ–∫–Ω–∞ –¥–ª—è –∞—Ä–±–∏—Ç—Ä–∞–∂–∞
- –ú–µ–Ω–µ–¥–∂–µ—Ä–∞ –ª–µ–≥—á–µ –Ω–∞–π—Ç–∏ (–±—ã–≤—à–∏–π —Å–Ω–∞–±–∂–µ–Ω–µ—Ü)

### –ü–æ—á–µ–º—É 20% / 35% –∫–æ–º–∏—Å—Å–∏—è?
- AI –¥–µ–ª–∞–µ—Ç 60-70% —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ª–∏–¥–∞—Ö (–Ω–∞—à—ë–ª, —Å–º–∞—Ç—á–∏–ª, —Ä–∞—Å—Å—á–∏—Ç–∞–ª –º–∞—Ä–∂—É, –Ω–∞–ø–∏—Å–∞–ª –¥—Ä–∞—Ñ—Ç)
- –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ª–∏–¥–µ ‚Äî "–ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è": –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, 2-3 —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–ø–ª–∞—Ç—ã
- –ü—Ä–∏ 50K –º–∞—Ä–∂–∞ √ó 20% = 10K –º–µ–Ω–µ–¥–∂–µ—Ä—É –∑–∞ 20-30 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ù–∞ —Å–≤–æ–∏—Ö –ª–∏–¥–∞—Ö –º–µ–Ω–µ–¥–∂–µ—Ä –¥–µ–ª–∞–µ—Ç –≤—Å—ë —Å–∞–º ‚Üí 35% —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ

### –ü–æ—á–µ–º—É agency –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?
- –ù–æ–ª—å –æ–±–æ—Ä–æ—Ç–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞
- –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å—Ç–æ—Ä–æ–Ω—ã, –ø–æ–ª—É—á–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞
- –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ transit ‚Äî –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ (>300K ‚ÇΩ), –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ö–æ–¥–∞
